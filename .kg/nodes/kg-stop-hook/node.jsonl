{"v": 1, "slug": "kg-stop-hook", "title": "kg-stop-hook", "type": "concept", "created_at": "2026-02-20T07:27:50.380864+00:00"}
{"id": "b-6e77018e", "type": "gotcha", "text": "Stop hook fires after every Claude response (not session end) \u2014 throttle with a lock file (120s) to avoid spawning N sonnet processes in an N-turn session.", "created_at": "2026-02-20T07:27:50.381046+00:00"}
{"id": "b-d4a26e85", "type": "gotcha", "text": "claude --resume resolves the session transcript from ~/.claude/projects/<cwd-hash>/<session_id>.jsonl \u2014 cwd-hash is derived from the cwd when the session was CREATED, not the hook event cwd. Fix: search ~/.claude/projects/*/<session_id>.jsonl and read cwd from first entry.", "created_at": "2026-02-20T07:27:55.562463+00:00"}
{"id": "b-d77a614a", "type": "gotcha", "text": "claude --resume needs the session's original cwd \u2014 search ~/.claude/projects/ for the transcript file and read cwd from its first entry [kg-architecture]", "created_at": "2026-02-20T07:28:02.703692+00:00"}
{"id": "b-00cbf373", "type": "fact", "text": "Use sys.executable (not hardcoded 'python') when installing hooks \u2014 ensures the Python with kg installed runs the hook. Same pattern as mg.", "created_at": "2026-02-20T07:28:24.611015+00:00"}
{"id": "b-59ffbbe5", "type": "gotcha", "text": "cwd for --resume: do NOT use data[\"cwd\"] from hook event \u2014 it is the hook's cwd which may differ from the session's project root (e.g. kg is sub-project). Use _find_session_cwd(): glob ~/.claude/projects/*/<session_id>.jsonl, decode encoded dir name to get original cwd.", "created_at": "2026-02-20T07:35:27.484229+00:00", "updated_at": "2026-02-20T08:32:57.938058+00:00"}
{"id": "b-7f6919f2", "type": "gotcha", "text": "cwd for --resume: use data[\"cwd\"] from the hook event directly \u2014 it IS the session project root. Do NOT read session JSONL files in the hook.", "created_at": "2026-02-20T07:35:50.354562+00:00"}
{"id": "b-6b354ecd", "type": "gotcha", "text": "cwd for --resume: use data[\"cwd\"] from the hook event directly \u2014 it IS the session project root. Do NOT read session JSONL files in the hook.", "created_at": "2026-02-20T07:36:19.475162+00:00"}
{"id": "b-e1243c9f", "type": "gotcha", "text": "cwd for --resume: use data[\"cwd\"] from the hook event directly \u2014 it IS the session project root. Do NOT read session JSONL files in the hook.", "created_at": "2026-02-20T07:38:05.876107+00:00"}
{"id": "b-d4a26e85", "deleted": true}
{"id": "b-d77a614a", "deleted": true}
{"id": "b-7f6919f2", "deleted": true}
{"id": "b-6b354ecd", "deleted": true}
{"id": "b-e1243c9f", "deleted": true}
{"id": "b-5f0253d7", "type": "note", "text": "test bullet UPDATED", "created_at": "2026-02-20T08:06:03.794622+00:00", "updated_at": "2026-02-20T08:06:08.232783+00:00"}
{"id": "b-5f0253d7", "deleted": true}
{"id": "b-4c65674e", "type": "gotcha", "text": "claude --resume <id> looks in ~/.claude/projects/<encoded-cwd>/ \u2014 cwd must match the session's original project dir, not the hook's cwd", "created_at": "2026-02-20T08:30:42.378194+00:00"}
{"id": "b-122de9b0", "type": "fact", "text": "glob('*/<session_id>.jsonl') under ~/.claude/projects/ finds the correct project dir without decoding ambiguity", "created_at": "2026-02-20T08:30:46.634902+00:00"}
{"id": "b-bd2dd4eb", "type": "fact", "text": "encoded project path uses lstrip and replace slashes with dashes; decode is lossy for paths with dashes in dir names but is_dir() check filters false positives", "created_at": "2026-02-20T08:30:57.625995+00:00"}
{"id": "b-bb08fe31", "type": "fact", "text": "kg start creates <project>/.claude \u2192 .kg/.claude symlink. Claude Code finds local settings/skills inside .kg/.claude/ when working in the project dir. [[how-to-use-kg]]", "created_at": "2026-02-20T08:31:01.353105+00:00", "updated_at": "2026-02-22T02:46:28.129725+00:00"}
{"id": "b-e266c987", "type": "fact", "text": "stop hook prompt: kg nodes in allowedTools lets extractor browse slugs for cross-links; kg delete removes promoted/transient bullets from fleeting node after processing", "created_at": "2026-02-20T08:33:30.204687+00:00"}
{"id": "b-811afd86", "type": "fact", "text": "kg review now shows Votes column (+u/-h) per node \u2014 aggregate useful/harmful counts across all live bullets", "created_at": "2026-02-20T08:33:38.307222+00:00"}
{"id": "b-dd4fab1a", "type": "fact", "text": "stop hook prompt: extractor must kg delete each fleeting bullet after promoting or discarding it. Only anchor bullets (intent/outcome) survive cleanup.", "created_at": "2026-02-20T08:37:23.440012+00:00"}
{"id": "b-e7f51048", "type": "fact", "text": "allowedTools includes kg nodes so extractor can browse existing slugs for cross-links.", "created_at": "2026-02-20T08:37:24.215691+00:00"}
{"id": "b-e7f51048", "deleted": true}
{"id": "b-122de9b0", "deleted": true}
{"id": "b-811afd86", "deleted": true}
{"id": "b-a01cb112", "type": "fact", "text": "allowedTools: kg add, kg show, kg nodes, kg search, kg context, kg review, kg create, kg vote, kg update, kg delete. kg nodes added so extractor can browse slugs for cross-links.", "created_at": "2026-02-20T08:45:31.324674+00:00"}
{"id": "b-8f648c6a", "type": "fact", "text": "Prompt Step 2 distinction: Promote+delete from fleeting vs Delete (transient, just remove) vs Defer (leave). After promoting or discarding a bullet, kg delete <bullet_id> from fleeting.", "created_at": "2026-02-20T08:45:31.915174+00:00"}
