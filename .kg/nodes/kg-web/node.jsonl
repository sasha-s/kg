{"v": 1, "slug": "kg-web", "title": "kg Web Viewer", "type": "concept", "created_at": "2026-02-20T09:58:21.099996+00:00"}
{"id": "b-ae9c1a0b", "type": "fact", "text": "kg web index page uses SQLite SELECT (slug, title, type, bullet_count) instead of iter_nodes() \u2014 avoids reading every node.jsonl; O(1) DB query vs O(N) file reads", "created_at": "2026-02-20T09:58:21.100322+00:00"}
{"id": "b-956a5398", "type": "fact", "text": "kg web _get_slugs_db(): SELECT slug FROM nodes \u2014 replaces FileStore.list_slugs() (iterdir + stat per dir) on every node and search page request", "created_at": "2026-02-20T09:58:21.100506+00:00"}
{"id": "b-c1b6898c", "type": "fact", "text": "kg web lazy Related section: node page renders <div id='kg-related'> placeholder + inline JS fetch('/api/related/<slug>'); page returns instantly, related loads async", "created_at": "2026-02-20T09:58:21.100679+00:00"}
{"id": "b-fc63f700", "type": "fact", "text": "/api/related/<slug> route: returns raw HTML fragment (no page wrapper); builds related via _related_html() after node page has already been sent to browser", "created_at": "2026-02-20T09:58:21.100840+00:00"}
{"id": "b-b319985c", "type": "fact", "text": "backlinks section (_backlinks_html) stays synchronous \u2014 it's fast (single DB query + read a few JSONL files); only Related is lazy (vector+FTS+reranker is the slow part)", "created_at": "2026-02-20T09:58:21.100986+00:00"}
{"id": "b-60370e13", "type": "fact", "text": "Search results page: doc results separated from concept node results, shown in collapsible 'Show N source file results' section (same docs-toggle-btn pattern as index page). Concept results show [[slug]] title format; doc results show <code>path</code> format.", "created_at": "2026-02-20T10:57:19.602737+00:00"}
{"id": "b-15ac3f37", "type": "fact", "text": "/agents page (agents tab): client-side filter input; TOML status badges (ag-paused=yellow, ag-draining=blue); pause/drain/resume control buttons on each card (form POST to /agent/<name>/ctrl); pending count from messages_db (not mux.db). _mux_agents() now merges runtime state from mux.db + TOML defs + messages.db counts. [[kg-agent-mux]]", "created_at": "2026-02-22T06:40:38.768026+00:00"}
{"id": "b-da2746a8", "type": "fact", "text": "/agent/<name> page: info bar (runtime status + TOML status + node + model), control buttons (pause/drain/resume form-POST to /ctrl), message thread from messages_db (fixed \u2014 was querying removed mux.db messages table), urgent checkbox in send form, auto-refresh every 8s via JS fetch (only when running, updates thread innerHTML without resetting scroll). [[kg-agent-mux]]", "created_at": "2026-02-22T06:40:42.220258+00:00"}
{"id": "b-02bcd45e", "type": "fact", "text": "POST /agent/<name>/ctrl route: accepts action=(pause|resume|drain) form field, calls update_agent_def() to write status to .kg/agents/<name>.toml, redirects back to agent page. POST /agent/<name>/message sends as urgency=urgent always (urgent hidden field, no checkbox). [[kg-agent-mux]] [[kg-agent-launcher]]", "created_at": "2026-02-22T06:40:46.870337+00:00", "updated_at": "2026-02-22T07:31:51.884731+00:00"}
{"id": "b-caa6c122", "type": "fact", "text": "/agent/<name> page: chat form at TOP (always visible); live-feed section (SSE 'turn'/'thinking' events) below; message thread (newest first, no scroll) below that. SSE via /agent/<name>/events (inotify + poll fallback). Ctrl buttons via fetch(). [[kg-agent-mux]]", "created_at": "2026-02-22T06:48:27.453384+00:00", "updated_at": "2026-02-22T09:12:11.353485+00:00"}
{"id": "b-1bc57c28", "type": "fact", "text": "/agents page improvements: client-side filter input (JS, hides cards whose data-name doesn't match); TOML status badges (ag-paused=yellow, ag-draining=blue, only when non-running); pause/drain/resume buttons per card; pending count from messages.db not mux.db. _mux_agents() merges: mux.db (runtime status/last_seen) + .kg/agents/*.toml (toml_status/node/model) + messages.db (pending count). [[kg-agent-mux]]", "created_at": "2026-02-22T06:48:34.510723+00:00"}
{"id": "b-af29e02b", "type": "fact", "text": "POST /agent/<name>/ctrl route: action=pause|resume|drain. Calls update_agent_def(cfg, name, status=...) to write TOML. Status map: pause\u2192paused, resume\u2192running, drain\u2192draining. Redirects back to /agent/<name>. Launcher picks up change via inotify or next poll.", "created_at": "2026-02-22T06:48:40.134048+00:00"}
{"id": "b-12f7efc7", "type": "fact", "text": "/agent/<name> page shows idle banner with 'kg run <name>' command when agent runtime status \\!= running \u2014 makes it obvious a session needs to be started. Messages sent while idle queue in mux and deliver on connect. [[kg-agent-mux]]", "created_at": "2026-02-22T07:09:28.336406+00:00"}
{"id": "b-6c6392b3", "type": "fact", "text": "Web agent message send: POST /agent/<name>/message redirects with ?sent=ok or ?sent=error (was silent suppress). Page renders green flash on success, red flash with 'kg mux start -d' hint on error. [[kg-agent-mux]]", "created_at": "2026-02-22T07:09:31.347539+00:00"}
{"id": "b-808458eb", "type": "fact", "text": "Web /agent/<name> page: shows idle banner when rt='idle' with 'kg run <name>' hint and note that 'kg launcher start' will auto-start on pending messages. Banner color: amber. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:13:35.466690+00:00"}
{"id": "b-7f010bde", "type": "fact", "text": "Web /agent/<name>/message POST: now returns ?sent=ok or ?sent=error query param on redirect. Error banner shown when mux unreachable (suggests 'kg mux start -d'). Previously silently suppressed all errors with contextlib.suppress.", "created_at": "2026-02-22T07:13:36.033214+00:00"}
{"id": "b-5988fb07", "type": "fact", "text": "Agent page /agent/<name>: chat form always sends as urgent (hidden field), so messages inject into running session via PostToolUse heartbeat hook. SSE EventSource (/agent/<name>/events) replaces 8s fetch poll; fires on messages.db change or session JSONL size change. Falls back to 12s poll if SSE fails. Green live-dot in h1 when connected. [[kg-agent-mux]]", "created_at": "2026-02-22T07:16:35.117708+00:00", "updated_at": "2026-02-22T09:02:40.229368+00:00"}
{"id": "b-b610e28d", "type": "fact", "text": "Idle banner on /agent/<name>: shown when mux status \\!= running. id='ag-idle-banner'. Text explains: messages queue + launcher will auto-start if running + 'kg run <name>' for manual. Banner disappears on next 8s auto-refresh after agent wakes.", "created_at": "2026-02-22T07:16:39.208602+00:00"}
{"id": "b-01b7ee0d", "type": "fact", "text": "POST /agent/<name>/message send feedback: redirects to /agent/<name>?sent=ok on success, ?sent=error if mux unreachable. Agent page renders green/red flash banner from query param. Previously errors were silently swallowed.", "created_at": "2026-02-22T07:16:43.412623+00:00"}
{"id": "b-da2746a8", "deleted": true}
{"id": "b-808458eb", "deleted": true}
{"id": "b-12f7efc7", "deleted": true}
{"id": "b-6c6392b3", "deleted": true}
{"id": "b-7f010bde", "deleted": true}
{"id": "b-1bc57c28", "deleted": true}
{"id": "b-9d48d0be", "type": "fact", "text": "Agent page send flow: POST /agent/<name>/message \u2192 forwards to mux URL \u2192 redirects to /agent/<name>?sent=ok or ?sent=error. Flash shown on GET via query param. Errors surface to user (was silently suppressed with contextlib.suppress before).", "created_at": "2026-02-22T07:20:32.896857+00:00"}
{"id": "b-1c649e51", "type": "fact", "text": "Agent page auto-refresh: always on (8s interval, regardless of agent status). Uses fetch+DOMParser to update msg-thread, ag-info-bar, and ag-idle-banner in place. Preserves scroll position.", "created_at": "2026-02-22T07:20:33.453206+00:00"}
{"id": "b-5ca10009", "type": "fact", "text": "/agent/<name> page auto-refresh: runs every 8s regardless of agent status (idle or running). Updates msg-thread innerHTML + ag-info-bar innerHTML + ag-idle-banner visibility by element ID. Preserves scroll position (checks if near bottom before update). Idle banner disappears automatically when agent wakes. [[kg-agent-mux]]", "created_at": "2026-02-22T07:24:59.473175+00:00"}
{"id": "b-a693144d", "type": "fact", "text": "Web UI agent chat: /agent/<name> page always sends messages as urgent (hidden field, no checkbox). Urgent = injected into running session via PostToolUse heartbeat. If agent is idle, launcher wakes it when pending-count > 0. Send shows green 'Message sent.' or red error banner. [[kg-agent-mux]] [[kg-agent-launcher]]", "created_at": "2026-02-22T07:31:22.858840+00:00"}
{"id": "b-14697ec5", "type": "fact", "text": "agents list page (/agents): each card now has a 'chat \u2192' button (green, top-right of card) linking to /agent/<name>. The chat form and message thread are only on the individual agent page, not the list.", "created_at": "2026-02-22T07:31:27.953674+00:00"}
{"id": "b-d5ad9619", "type": "fact", "text": "/agent/<name> page: idle banner shows when runtime status \\!= running \u2014 explains 'kg launcher start' auto-starts on pending messages, or manual 'kg run <name>'. Auto-refresh runs every 8s regardless of status (not just when running), updating msg-thread + info bar + idle banner via JS fetch. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:31:32.855223+00:00"}
{"id": "b-da2746a8", "deleted": true}
{"id": "b-1bc57c28", "deleted": true}
{"id": "b-1aae1597", "type": "fact", "text": "/logs/launcher route \u2014 renders last 200 lines of .kg/logs/launcher.log with 5s auto-refresh", "created_at": "2026-02-22T07:41:09.109280+00:00"}
{"id": "b-8738ca0c", "type": "fact", "text": "chat \u2192 button added to each agent card on /agents list page; previously chat was hidden on /agent/<name> page with no obvious entry point", "created_at": "2026-02-22T07:41:12.214550+00:00"}
{"id": "b-79ccd543", "type": "decision", "text": "web UI chat always sends urgent (hidden input); removed urgent checkbox \u2014 urgent needed for in-session injection via heartbeat hook", "created_at": "2026-02-22T07:41:13.992622+00:00"}
{"id": "b-8a4e152c", "type": "fact", "text": "Agents tab (/agents): lists all agents with status badge, pending count, pause/drain/resume controls, and 'chat \u2192' button. Agent detail page (/agent/<name>): chat form (always urgent), message thread, idle banner with kg run hint, auto-refresh 8s. /logs/launcher: last 200 lines of .kg/logs/launcher.log, auto-refresh 5s. [[kg-agent-mux]]", "created_at": "2026-02-22T07:49:46.217975+00:00"}
{"id": "b-28127220", "type": "gotcha", "text": "msg thread at /agent/<name> queries WHERE to_agent=name OR from_agent=name \u2014 shows BOTH incoming messages AND agent replies in one thread. Agent replies stored in same messages.db only if sender's kg_root is used (mux _handle_send bug: uses recip root by default, must prefer sender root for unregistered recipients like 'web')", "created_at": "2026-02-22T08:01:43.423156+00:00"}
{"id": "b-9b337369", "type": "fact", "text": "Agents list TOML filter: _list_agents() marks _has_toml=True only for agents with a .kg/agents/<name>.toml. Final list filters to _has_toml only (fallback: show all). Prevents auto-registered pseudo-agents (e.g. 'web' sender) from appearing as launchable agents. [[kg-agent-mux]]", "created_at": "2026-02-22T08:34:08.413222+00:00"}
{"id": "b-04eb163a", "type": "fact", "text": "/api/preview/<slug> endpoint: returns JSON {title, bullets[]} for hover popup. New in web.py as _preview_json() \u2014 loads node from FileStore, returns first 4 bullets truncated to 120 chars. [[kg-agent-launcher]]", "created_at": "2026-02-22T08:53:44.306503+00:00"}
{"id": "b-c5c90500", "type": "fact", "text": "[[slug]] links in _render() now have data-slug attribute; global _GLOBAL_JS on every page fetches /api/preview/<slug> on mouseover, caches results, shows fixed-position popup with title + 4 bullet previews", "created_at": "2026-02-22T08:53:48.283018+00:00"}
{"id": "b-ee83b912", "type": "fact", "text": "Settings panel: gear button in nav opens font-size slider (11-20px range). Font size persisted in localStorage['kg-font-size'] and restored via _GLOBAL_JS on every page load", "created_at": "2026-02-22T08:53:53.907825+00:00"}
{"id": "b-4589da78", "type": "fact", "text": "Agent page message bodies rendered via _render() (not html.escape) \u2014 [[slug]] links are clickable with hover previews; session list shows 1-line preview (first summary/user turn, 100 chars)", "created_at": "2026-02-22T08:53:54.532773+00:00"}
{"id": "b-24c9f90b", "type": "fact", "text": "_agent_link_for_node(): agent-type nodes get '\u2192 agent page' link in h1. Nodes matching *-mission (preferred), *-instructions (legacy), or *-knowledge slugs get link to /agent/<base> if .kg/agents/<base>.toml exists.", "created_at": "2026-02-22T08:53:55.159375+00:00", "updated_at": "2026-02-22T09:25:20.628498+00:00"}
{"id": "b-af29e02b", "deleted": true}
{"id": "b-9d48d0be", "deleted": true}
{"id": "b-1c649e51", "deleted": true}
{"id": "b-8738ca0c", "deleted": true}
{"id": "b-d5ad9619", "deleted": true}
{"id": "b-a693144d", "deleted": true}
{"id": "b-0e84396c", "type": "fact", "text": "settings panel pattern: gear button (\u2699) in nav opens a slide-in panel; font size range slider (11-36px) stored in localStorage['kg-font-size'] and restored on page load; panel closes on outside click", "created_at": "2026-02-22T08:59:12.314978+00:00", "updated_at": "2026-02-22T09:25:30.569732+00:00"}
{"id": "b-28dee95d", "type": "gotcha", "text": "session list preview: sessions tuple changed from (stem, mtime) to (stem, mtime, preview) \u2014 preview = first summary text or first user turn text, truncated at 100 chars. Any future code unpacking sessions must handle 3 values.", "created_at": "2026-02-22T08:59:16.401247+00:00"}
{"id": "b-e74953f4", "type": "fact", "text": "hover preview for [[slug]] links: add data-slug attr in _render(), serve /api/preview/<slug> returning {title, bullets[]}; _GLOBAL_JS fetches on mouseover (200ms hide delay, JS LRU cache, position:fixed popup)", "created_at": "2026-02-22T08:59:20.878543+00:00"}
{"id": "b-5d54cb36", "type": "fact", "text": "agent-type nodes get '\u2192 agent page' link in h1 if .kg/agents/{name}.toml exists; {name}-instructions and {name}-knowledge pattern also resolve via _agent_link_for_node()", "created_at": "2026-02-22T08:59:24.749622+00:00"}
{"id": "b-ee83b912", "deleted": true}
{"id": "b-f905d350", "type": "fact", "text": "SSE streaming for /agent/<name>: GET /agent/<name>/events returns text/event-stream (via ThreadingMixIn); server polls every 1s for new messages + JSONL session file size changes; sends 'event: update' on any change, 'event: ping' keepalive every 25s; client reconnects on error (5s delay), falls back to 12s interval poll if SSE never succeeds [[kg-agent-mux]]", "created_at": "2026-02-22T09:00:43.524981+00:00"}
{"id": "b-4e3b6602", "type": "fact", "text": "SSE live indicator: green animated dot (.live-dot) appears in /agent/<name> h1 once first ping arrives; client tracks sseOk=true to suppress fallback poll once SSE is confirmed working", "created_at": "2026-02-22T09:00:47.113769+00:00"}
{"id": "b-2e2875d7", "type": "fact", "text": "mobile UX via @media(max-width:640px): nav wraps (brand+agents row 1, settings row 2, search row 3); main padding reduced; agent card grid collapses to 1 column; msg-thread max-height 55vh; h1 font-size 1.2rem", "created_at": "2026-02-22T09:00:51.592532+00:00"}
{"id": "b-267a5af3", "type": "fact", "text": "/agent/<name>/events SSE endpoint: streams 'update' event when messages.db has new rows (id > last_seen) or session JSONL file grows. Polls every 1s in a daemon thread. Sends 'ping' keepalive every 25s. Client uses EventSource; on error closes + reconnects after 5s. Falls back to 12s fetch poll if SSE never connects. [[kg-agent-mux]]", "created_at": "2026-02-22T09:02:46.359510+00:00"}
{"id": "b-1d9bc51e", "type": "fact", "text": "light/dark mode toggle: \ud83c\udf19/\u2600 nav button, html.light CSS class overrides for light theme, default dark; preference stored in localStorage['kg-theme']; no flash on load (script sets class before page renders)", "created_at": "2026-02-22T09:02:51.219221+00:00"}
{"id": "b-1a8b38a0", "type": "fact", "text": "/api/preview/<slug> endpoint: returns JSON {title, bullets[]} for hover preview popups. _render() adds data-slug attr to all [[slug]] links. _GLOBAL_JS in every page attaches mouseover handler that fetches /api/preview/<slug> on hover and shows a fixed-position popup. Results cached client-side.", "created_at": "2026-02-22T09:02:52.098585+00:00"}
{"id": "b-6f3fdcf6", "type": "fact", "text": "_render() applied to session turn text: user + assistant turns in /session/<name>/<id> page now render [[slug]] links, bold, code, URL links with hover previews \u2014 previously was html.escape() only", "created_at": "2026-02-22T09:02:56.933886+00:00"}
{"id": "b-3d768525", "type": "fact", "text": "Light/dark mode toggle: html.light class on <html> element overrides CSS vars (--bg:#fff, --sf:#f6f8fa, --bd:#d0d7de, --tx:#1f2328, --ac:#0969da). Moon/sun emoji button in nav. localStorage['kg-theme'] persists choice. applyTheme() called before paint to avoid flash.", "created_at": "2026-02-22T09:02:58.310515+00:00"}
{"id": "b-573dbeca", "type": "fact", "text": "agent page message thread: latest messages shown on top (reversed(messages)); scroll-to-bottom JS removed; SSE update events maintain newest-first order", "created_at": "2026-02-22T09:03:00.796574+00:00"}
{"id": "b-03a4a604", "type": "fact", "text": "_GLOBAL_JS injected into every page via _page(): handles hover previews (fetch+cache), settings panel toggle, font-size restore from localStorage, theme toggle (applyTheme). Single JS block avoids duplicating logic across pages.", "created_at": "2026-02-22T09:03:02.995266+00:00"}
{"id": "b-1eb8d706", "type": "note", "text": "(pending) SSE streaming in _stream_agent_events() uses 1s poll \u2014 task assigned to replace with inotify (already a dep via inotify-simple) watching messages.db + session JSONL files; no new deps needed [[kg-architecture]]", "created_at": "2026-02-22T09:03:06.108854+00:00"}
{"id": "b-ae077c53", "type": "fact", "text": "_agent_link_for_node(): node pages with type='agent' get '\u2192 agent page' link in h1. Nodes matching *-mission (preferred), *-instructions (legacy), or *-knowledge slugs get link to /agent/<base> if .kg/agents/<base>.toml exists.", "created_at": "2026-02-22T09:03:09.043787+00:00", "updated_at": "2026-02-22T09:25:24.132924+00:00"}
{"id": "b-5f7e5a58", "type": "fact", "text": "Message thread in /agent/<name> shows newest first (Python reversed(messages)). No scroll-to-bottom logic needed. Session list shows preview text (first user turn or summary, truncated 100 chars). Session page turns apply _render() so [[slug]] links are clickable.", "created_at": "2026-02-22T09:03:14.647162+00:00"}
{"id": "b-04eb163a", "deleted": true}
{"id": "b-c5c90500", "deleted": true}
{"id": "b-267a5af3", "deleted": true}
{"id": "b-5d54cb36", "deleted": true}
{"id": "b-0c64ff09", "type": "fact", "text": "Mobile responsive: @media(max-width:640px) \u2014 nav wraps (search full-width row 3), main padding 14px 12px, ag-grid 1 column, msg-thread max-height 55vh, reduced bullet/button padding. Settings+theme buttons order:2/3 in flex wrap.", "created_at": "2026-02-22T09:03:20.855415+00:00"}
{"id": "b-53674da0", "type": "task", "text": "(pending) SSE 1s poll in _stream_agent_events() should be replaced with inotify-simple watches on messages.db + session JSONL dirs \u2014 inotify-simple is already a dep (Linux-only) so no new dep needed [[kg-architecture]]", "status": "pending", "created_at": "2026-02-22T09:03:25.231551+00:00"}
{"id": "b-1eb8d706", "deleted": true}
{"id": "b-53674da0", "deleted": true}
{"id": "b-7e43fec4", "type": "fact", "text": "SSE streaming endpoint /agent/<name>/events: inotify watches .kg/index/ (messages.db) + sessions_dir/<agent>/ (*.jsonl); fires update event immediately on CLOSE_WRITE; 25s keepalive ping; ImportError fallback to 1s poll for macOS/Docker compat [[kg-agent-launcher]]", "created_at": "2026-02-22T09:05:26.931794+00:00"}
{"id": "b-599a1cb5", "type": "fact", "text": "inotify-based SSE in _stream_agent_events(): watches .kg/index/ (CLOSE_WRITE|MOVED_TO) for messages.db changes + sessions_dir/<agent>/ (CLOSE_WRITE|CREATE|MOVED_TO) for JSONL changes; handles missing sessions dir by watching parent then upgrading; inotify.read(timeout=ms) blocks until event or 25s ping; filters to messages.db or *.jsonl filenames only; ImportError fallback to 1s poll (macOS compat) [[kg-agent-launcher]]", "created_at": "2026-02-22T09:05:29.336133+00:00"}
{"id": "b-c9fbc159", "type": "fact", "text": "Agent page live-dot indicator: EventSource('/agent/<name>/events') client; green animated dot appears after first ping; on SSE error closes+waits 5s+reconnects; fallback 12s poll if SSE never succeeds", "created_at": "2026-02-22T09:05:33.465475+00:00"}
{"id": "b-e9b35b0a", "type": "fact", "text": "[[slug]] hover previews: /api/preview/<slug> returns {title, bullets[]} JSON; data-slug attr on rendered links; JS popup with 200ms hide delay and LRU cache; position:fixed via getBoundingClientRect()", "created_at": "2026-02-22T09:05:34.101237+00:00"}
{"id": "b-4d650d79", "type": "fact", "text": "Settings panel: gear button (\u2699) in nav; font-size range slider (11-36px); localStorage['kg-font-size'] persistence; closes on outside click", "created_at": "2026-02-22T09:05:39.288561+00:00", "updated_at": "2026-02-22T09:25:31.613403+00:00"}
{"id": "b-924d09d8", "type": "fact", "text": "Light/dark theme toggle: \ud83c\udf19/\u2600 nav button; html.light CSS class for light theme overrides; localStorage['kg-theme'] persistence; default dark; no flash on load", "created_at": "2026-02-22T09:05:39.939197+00:00"}
{"id": "b-968ea439", "type": "fact", "text": "Session list preview: shows 1-line preview (first summary or first user turn, truncated at 100 chars) alongside session ID and timestamp in flex layout", "created_at": "2026-02-22T09:05:45.398603+00:00"}
{"id": "b-a2d64ed2", "type": "fact", "text": "Agent-type node page gets '\u2192 agent page' link in <h1> if matching .kg/agents/<name>.toml exists; pattern matches agent-<name>-mission (primary) and agent-<name>-instructions (legacy) and agent-<name>-knowledge slugs", "created_at": "2026-02-22T09:05:46.032736+00:00", "updated_at": "2026-02-22T09:25:25.874228+00:00"}
{"id": "b-25bb5de5", "type": "fact", "text": "Mobile responsive CSS at @media(max-width:640px): nav wraps to 3 rows, agent card grid \u2192 1 col, msg-thread max-height 55vh, reduced padding, h1 1.2rem", "created_at": "2026-02-22T09:05:55.330666+00:00"}
{"id": "b-0999364d", "type": "fact", "text": "_render() applied to: agent message bodies, user+assistant session turn text \u2014 enables [[slug]] links, bold, code, URL links in all text areas [[kg-architecture]]", "created_at": "2026-02-22T09:05:55.980358+00:00"}
{"id": "b-1195ac03", "type": "success", "text": "improve-web agent shipped 10 web UX improvements in 2 rounds: round 1 \u2014 hover previews for [[slug]] links, [[slug]] rendering in messages, settings panel (font size), session list previews, agent page links from node pages, SSE streaming, green live-dot, mobile CSS; round 2 \u2014 light/dark mode toggle, [[slug]] rendering in session turns, newest messages on top. [[kg-agent-mux]]", "created_at": "2026-02-22T09:06:24.727006+00:00"}
{"id": "b-bba2a5bf", "type": "fact", "text": "SSE streaming at /agent/<name>/events: inotify_simple watches .kg/index/ (CLOSE_WRITE) for messages.db and .kg/sessions/<agent>/ for .jsonl changes \u2014 fires 'update' event immediately. Falls back to 1s polling on macOS/Docker (ImportError). Keepalive 'ping' every 25s. [[kg-agent-mux]]", "created_at": "2026-02-22T09:10:45.148192+00:00"}
{"id": "b-47ad175c", "type": "fact", "text": "web.py shipped features (v0.3.35 era, rounds 1\u20134): hover previews on [[slug]] links, [[slug]] rendering in agent messages + session turns, settings panel (font 11\u201336px), session list with preview text, agent-page links from node pages, SSE streaming (inotify-driven), green live-dot SSE indicator, mobile responsive CSS, light/dark mode toggle (localStorage), latest messages on top, streaming thinking indicators + live turn feed, fetch() replacing native form POSTs (eliminates mobile security warnings), sticky chat input (position:sticky), agent KG/mission node links on info bar, instructions\u2192mission rename [[kg-architecture]]", "created_at": "2026-02-22T09:10:46.343820+00:00", "updated_at": "2026-02-22T09:26:01.273764+00:00"}
{"id": "b-b2a843d4", "type": "fact", "text": "Agent page streaming thinking indicators: _extract_turn_for_sse() parses new JSONL lines and emits 'thinking' + 'turn' SSE events as session.jsonl is appended. Client shows #live-feed div with per-turn HTML prepended (newest first), animated thinking-dot auto-hides after 6s quiet.", "created_at": "2026-02-22T09:10:48.795065+00:00"}
{"id": "b-4ef46b83", "type": "fact", "text": "SSE streaming pattern in web.py: _stream_agent_events() uses inotify (CLOSE_WRITE|MOVED_TO) to watch .kg/index/ (messages.db) and sessions_dir/<agent>/ (*.jsonl); fires 'update' SSE event immediately on change; 25s keepalive ping; ImportError fallback to 1s poll for macOS/Docker compat; client EventSource reconnects after 5s on error [[kg-architecture]]", "created_at": "2026-02-22T09:10:51.733804+00:00"}
{"id": "b-0dc0db4f", "type": "fact", "text": "Agent page layout (current): chat input at TOP \u2192 live-feed (session stream) \u2192 messages thread (newest first, no max-height scroll box). Chat form uses fetch() for submit \u2014 no native POST avoids mobile 'insecure site' warning on HTTP.", "created_at": "2026-02-22T09:10:52.827937+00:00"}
{"id": "b-f09ecf1a", "type": "gotcha", "text": "gotcha: sessions list in _render_agent_page is a 3-tuple (stem, mtime, preview) \u2014 not 2-tuple. Any code unpacking sessions must use all 3 values.", "created_at": "2026-02-22T09:10:55.244513+00:00"}
{"id": "b-15cae2d1", "type": "fact", "text": "/api/preview/<slug>: returns JSON {title, bullets[]} for hover previews. [[slug]] links in _render() get data-slug attr; _GLOBAL_JS shows .kg-pv fixed popup on mouseover with LRU cache, 200ms hide delay.", "created_at": "2026-02-22T09:10:56.421788+00:00"}
{"id": "b-c2466b95", "type": "success", "text": "fetch() pattern for form actions: replace native <form method=post> with onclick\u2192fetch() to eliminate mobile browser 'insecure form submission' warnings. Pattern: fetch POST \u2192 on success call location.reload() or splice DOM update (SSE handles live content).", "created_at": "2026-02-22T09:10:59.472992+00:00"}
{"id": "b-600a06c0", "type": "fact", "text": "Light/dark theme: html.light CSS class with --bg:#fff --sf:#f6f8fa overrides. Nav button \ud83c\udf19/\u2600 toggles, stored in localStorage['kg-theme']. Font size slider 11-36px in settings panel, persisted in localStorage['kg-font-size']. Both applied before paint via _GLOBAL_JS.", "created_at": "2026-02-22T09:11:00.600282+00:00"}
{"id": "b-01e552a0", "type": "gotcha", "text": "Mobile: fetch() for all form submits (chat + ctrl buttons) avoids Vivaldi/mobile 'insecure site' warning on HTTP. @media(max-width:640px) responsive CSS. Session list shows preview text (first user turn or summary). Messages newest-on-top.", "created_at": "2026-02-22T09:11:05.334543+00:00"}
{"id": "b-bf1a90a4", "type": "gotcha", "text": "mobile browser 'insecure site' warning triggered by native <form method='post'> submissions \u2014 replace with fetch() calls to eliminate warning. Chat form + ctrl buttons (pause/drain/resume) all converted to fetch() in web.py. SSE handles page updates after fetch, no reload needed for chat.", "created_at": "2026-02-22T09:11:20.676506+00:00"}
{"id": "b-228830c6", "type": "fact", "text": "web.py SSE streaming: /agent/<name>/events uses inotify_simple to watch .kg/index/ (messages.db) and sessions_dir/<agent>/ (JSONL files). Fires event: update immediately on CLOSE_WRITE|MOVED_TO. Keepalive ping every 25s. ImportError fallback to 1s poll for macOS/Docker. Client: EventSource + reconnect on error, fallback to 12s poll if SSE never connects. [[kg-agent-mux]]", "created_at": "2026-02-22T09:11:26.747938+00:00"}
{"id": "b-02383510", "type": "fact", "text": "SSE streaming endpoint /agent/<name>/events: inotify watches index/ (messages.db CLOSE_WRITE) + sessions/<name>/ (jsonl CLOSE_WRITE/CREATE); emits 'update', 'thinking', 'turn' events; falls back to 1s poll on non-Linux. Replaces 8s fetch poll. [[kg-architecture]]", "created_at": "2026-02-22T09:11:28.985484+00:00"}
{"id": "b-e2c7022e", "type": "gotcha", "text": "(gotcha) SSE _stream_agent_events: sessions_dir may not exist at connect time \u2014 watches parent cfg.sessions_dir for CREATE to detect when agent subdir is first created, then upgrades to direct CLOSE_WRITE watch. Handles agents with no sessions yet.", "created_at": "2026-02-22T09:11:33.038059+00:00"}
{"id": "b-0836fa87", "type": "fact", "text": "Hover preview popup for [[slug]] links: /api/preview/<slug> returns {title, bullets[]} JSON; links get data-slug attr; global JS shows fixed-position .kg-pv popup on mouseover with 200ms hide delay and per-slug LRU cache", "created_at": "2026-02-22T09:11:34.229176+00:00"}
{"id": "b-1b6b83f0", "type": "fact", "text": "Light/dark theme toggle: html.light CSS class with variable overrides; \ud83c\udf19/\u2600 nav button; localStorage['kg-theme']; Settings panel (\u2699 nav button) has font-size slider 11\u201336px persisted in localStorage['kg-font-size']", "created_at": "2026-02-22T09:11:38.294374+00:00"}
{"id": "b-1bfae524", "type": "fact", "text": "Agent page layout: chat form at top (always visible) \u2192 live-feed section (hidden until first SSE session activity) \u2192 message thread (newest first, no max-height scroll). Live-feed: #live-turns prepended on 'turn' SSE events, thinking-dot spinner on 'thinking' events (fades 6s).", "created_at": "2026-02-22T09:11:42.325122+00:00"}
{"id": "b-22876268", "type": "gotcha", "text": "All agent-page form submissions use fetch() to avoid mobile browser HTTP form warnings: chat form uses sendMsg() JS, ctrl buttons use inline onclick fetch. Both agents list page and agent detail page converted.", "created_at": "2026-02-22T09:11:46.973525+00:00"}
{"id": "b-3142d1a7", "type": "fact", "text": "Streaming thinking indicators: _extract_turn_for_sse(entry, slugs) parses JSONL entries to HTML with [[slug]] links + tool badges; _stream_agent_events reads new bytes from JSONL offset on size increase and emits 'thinking' + per-'turn' SSE events", "created_at": "2026-02-22T09:11:51.250605+00:00"}
{"id": "b-c94dca5e", "type": "fact", "text": "_render() applied everywhere: session page turn text (user+assistant), agent message bodies \u2014 [[slug]] links clickable with hover previews, bold/code formatting throughout. Session page also loads slugs for rendering.", "created_at": "2026-02-22T09:11:55.401328+00:00"}
{"id": "b-b9d404f6", "type": "fact", "text": "Mobile responsive CSS: @media(max-width:640px) \u2014 nav wraps (search full-width row 3), main padding 14px 12px, ag-grid single column, msg-thread max-height 55vh, reduced bullet/info-bar padding", "created_at": "2026-02-22T09:12:00.764763+00:00"}
{"id": "b-5166493c", "type": "fact", "text": "Agent node links in node pages: _agent_link_for_node() detects agent-type nodes \u2192 links to /agent/<slug>; also matches {name}-instructions and {name}-knowledge slugs \u2192 links to /agent/{name} if .kg/agents/{name}.toml exists", "created_at": "2026-02-22T09:12:05.813497+00:00"}
{"id": "b-e96d65bb", "type": "fact", "text": "Streaming thinking indicators: server emits 'event: thinking' + 'event: turn' (rendered HTML) via SSE as session JSONL is written; client shows animated .thinking-dot + prepends live turns to #live-turns div; auto-hides after 6s quiet. [[kg-agent-mux]]", "created_at": "2026-02-22T09:12:44.985518+00:00"}
{"id": "b-db50d1f8", "type": "fact", "text": "inotify-driven SSE in _stream_agent_events(): watches .kg/index/ (CLOSE_WRITE|MOVED_TO) for messages.db and sessions_dir/<agent>/ for *.jsonl writes. Fires events immediately; falls back to 1s poll on ImportError (macOS compat). No new deps \u2014 inotify-simple already a core dep. [[kg-architecture]]", "created_at": "2026-02-22T09:12:51.124808+00:00"}
{"id": "b-4f6e1991", "type": "fact", "text": "Light/dark mode toggle: \ud83c\udf19/\u2600 nav button, html.light CSS class overrides (GitHub-light theme), localStorage['kg-theme'] persistence, default dark. No flash on load (class applied before paint via inline script).", "created_at": "2026-02-22T09:12:55.126990+00:00"}
{"id": "b-c38849e5", "type": "fact", "text": "[[slug]] rendering in session page turns: _render() applied to user + assistant turn text in session view, enabling hover previews and clickable [[slug]] links in historical session content.", "created_at": "2026-02-22T09:12:59.740882+00:00"}
{"id": "b-9dc9ffe0", "type": "fact", "text": "Settings panel: gear button (\u2699) in nav; slides in font-size range slider (11\u201336px); persists in localStorage['kg-font-size']; closes on outside click.", "created_at": "2026-02-22T09:13:05.657202+00:00"}
{"id": "b-737cf141", "type": "fact", "text": "Session list previews: each session entry shows 1-line preview (first summary text or first user turn, truncated at 100 chars). Layout: session ID | preview (flex:1) | timestamp.", "created_at": "2026-02-22T09:13:08.887616+00:00"}
{"id": "b-163060ed", "type": "fact", "text": "Mobile responsive CSS (@media max-width:640px): nav wraps to 3 rows, main padding reduced, agent card grid 1 column, msg-thread max-height 55vh, h1 font-size 1.2rem.", "created_at": "2026-02-22T09:13:12.401795+00:00"}
{"id": "b-0add2ad0", "type": "success", "text": "improve-web mission complete (14 features): hover previews for [[slug]] links, [[slug]] rendering in messages+sessions, font size settings panel (11-36px), session list previews, agent links from node pages, SSE streaming (replacing 8s poll), green live-dot indicator, mobile responsive CSS, light/dark mode toggle (localStorage), latest messages on top, inotify SSE (instant, no poll), streaming thinking indicators + live turn feed, chat input moved to top, fetch() replacing native form POSTs (fixes mobile security warnings)", "created_at": "2026-02-22T09:17:25.017925+00:00"}
{"id": "b-8ebfc9e8", "type": "fact", "text": "instructions\u2192mission rename (Round 4): all agent-*-instructions nodes/dirs renamed to agent-*-mission. hooks.py loads from agent-<name>-mission with fallback to -instructions. cli.py kg agents init creates -mission node. web.py recognizes both -mission and -instructions suffixes. [[agent-delegation]]", "created_at": "2026-02-22T09:24:39.488214+00:00"}
{"id": "b-ed9d93f2", "type": "fact", "text": "web.py Round 4 UX additions: (1) sticky chat input (position:sticky below nav), (2) agent page info bar shows KG node link + mission link when those nodes exist, (3) SSE endpoint uses inotify (not 1s poll) watching .kg/index/ and sessions_dir/<agent>/ with ImportError fallback to poll", "created_at": "2026-02-22T09:24:44.603294+00:00"}
{"id": "b-816bfd9f", "type": "task", "text": "session page improvements (pending Round 5): collapsible <details> blocks for tool use/results, visual distinction user vs assistant turns, apply _render() to assistant turn text for [[slug]] links and formatting", "status": "pending", "created_at": "2026-02-22T09:24:48.496908+00:00"}
{"id": "b-9bfa0f5c", "type": "fact", "text": "sticky chat input: chat form div wrapped in <div class='chat-sticky'> with position:sticky;top:46px;z-index:50 \u2014 stays below nav bar while message thread scrolls freely. Prevents chat form from disappearing on long message lists.", "created_at": "2026-02-22T09:25:37.265355+00:00"}
{"id": "b-37cacef6", "type": "fact", "text": "Agent page info bar includes 'KG node' link \u2192 /node/agent-<name> and 'mission' link \u2192 /node/agent-<name>-mission if those slugs exist in the DB. Both links shown only when the slug is present (no dead links).", "created_at": "2026-02-22T09:25:39.571326+00:00"}
{"id": "b-a7218d41", "type": "gotcha", "text": "SSE streaming caveat: _stream_agent_events() watches .kg/sessions/<agent>/ \u2014 this dir is populated by the stop hook (copies Claude Code transcript at session END). Live in-session streaming would require watching the live ~/.claude/projects/.../<session_id>.jsonl file directly instead.", "created_at": "2026-02-22T09:25:44.498880+00:00"}
{"id": "b-9162a775", "type": "note", "text": "Next improvement (pending): session page /session/<agent>/<id> \u2014 show tool use + tool results in collapsible <details> blocks; clearer user vs assistant visual distinction; _render() already applied to text but tool calls are currently skipped.", "created_at": "2026-02-22T09:25:46.753475+00:00"}
{"id": "b-6c09e8b9", "type": "fact", "text": "session page turn rendering: _parse_session() merges tool_result entries into preceding assistant turn by tool_use_id; each tool call shows collapsible '\u21b3 result' block (green .tool-result CSS); thinking blocks show collapsed '\ud83d\udcad thinking (N chars)' summary in amber; assistant turns have subtle left border for visual separation [[kg-architecture]]", "created_at": "2026-02-22T09:29:09.546034+00:00"}
{"id": "b-1d81eecb", "type": "fact", "text": "kg web --dev flag: spawns web server as subprocess, watches src/kg/ with inotify_simple for .py changes, kills+restarts on change. Falls back to 1s poll if inotify unavailable.", "created_at": "2026-02-22T09:34:07.902306+00:00"}
{"id": "b-d4da0741", "type": "fact", "text": "Session page _parse_session() now: (1) extracts thinking blocks from assistant turns, (2) parses tool_result from user messages and merges into preceding assistant turn by tool_use_id, (3) stores tool_call id field. _render_session_page() shows tool results as collapsible '\u21b3 result' (green .tool-result), thinking as collapsed '\ud83d\udcad thinking (N chars)' (amber .thinking-block). Assistant turns get subtle left border for visual parity with user turns.", "created_at": "2026-02-22T09:35:23.960126+00:00"}
{"id": "b-90f2666e", "type": "fact", "text": "Live session streaming: _get_live_session_path(cfg, agent_name) queries cfg.mux_db_path (~/.local/share/kg/mux.db) agents table for session_id, then globs ~/.claude/projects/*/<session_id>.jsonl. SSE stream now watches this live file via inotify MODIFY on ~/.claude/projects/<encoded-root>/. Complement to .kg/sessions/<agent>/ (archived at stop). [[kg-agent-mux]]", "created_at": "2026-02-22T09:35:30.118061+00:00"}
{"id": "b-410d59ee", "type": "gotcha", "text": "GOTCHA: Path is only imported under TYPE_CHECKING in web.py (from __future__ import annotations + if TYPE_CHECKING: from pathlib import Path). Any runtime use of Path.home(), Path(), etc. in function bodies requires local import: 'from pathlib import Path as _Path' inside the function. NameError is silently swallowed by contextlib.suppress(Exception).", "created_at": "2026-02-22T09:35:35.462308+00:00"}
{"id": "b-55e1f13a", "type": "fact", "text": "Sticky chat: .chat-sticky { position:sticky; top:46px; z-index:50 } wraps the chat form div on agent page. Agent page info bar links: 'KG node' \u2192 /node/agent-<name>, 'mission' \u2192 /node/agent-<name>-mission (if slug exists in DB).", "created_at": "2026-02-22T09:35:40.553748+00:00"}
{"id": "b-24c9f90b", "deleted": true}
{"id": "b-ae077c53", "deleted": true}
{"id": "b-a2d64ed2", "deleted": true}
{"id": "b-75fb547f", "type": "fact", "text": "kg web --dev flag: spawns server as subprocess + watches src/kg/**/*.py with inotify_simple (falls back to 1s mtime polling). Restarts server subprocess on any .py change. Works because inotify_simple is already a core dep on Linux.", "created_at": "2026-02-22T09:36:56.970220+00:00"}
{"id": "b-647b0ee7", "type": "gotcha", "text": "gotcha: Path in web.py is TYPE_CHECKING-only \u2014 runtime calls like Path.home() raise NameError silently inside contextlib.suppress(). Fix: add 'from pathlib import Path as _Path' inside the function body where needed.", "created_at": "2026-02-22T09:37:43.903113+00:00"}
{"id": "b-32f0bd4a", "type": "fact", "text": "live session streaming: _get_live_session_path(cfg, agent_name) queries cfg.mux_db_path (~/.local/share/kg/mux.db) for agent's session_id, then globs ~/.claude/projects/*/<session_id>.jsonl to find live transcript. inotify watches that dir for MODIFY/CLOSE_WRITE events. [[kg-agent-mux]]", "created_at": "2026-02-22T09:37:51.448344+00:00"}
{"id": "b-54dcdfdf", "type": "fact", "text": "session page _parse_session(): parses tool_result entries from user messages, merges into preceding assistant turn by tool_use_id. Also parses thinking content blocks. _render_session_page() shows tool results as collapsible .tool-result divs (green) and thinking blocks as .thinking-block (amber).", "created_at": "2026-02-22T09:37:56.311363+00:00"}
{"id": "b-568dc87d", "type": "fact", "text": "kg web --dev mode: spawns server as subprocess and watches src/kg/ with inotify_simple; restarts server subprocess on any .py change. Falls back to 1s mtime polling if inotify unavailable. For development iteration. [[kg-architecture]]", "created_at": "2026-02-22T09:43:00.024094+00:00"}
{"id": "b-77d4e339", "type": "fact", "text": "TOML-only agent filter in web UI: _list_agents() sets _has_toml=True on agents with .kg/agents/<name>.toml files and filters result to only those. Prevents pseudo-agents like 'web' (auto-registered in mux.db) from cluttering the agents list.", "created_at": "2026-02-22T09:43:04.136128+00:00"}
{"id": "b-02486027", "type": "fact", "text": "web.py _parse_session() now handles: 'thinking' content type (agent inner monologue, stored in assistant turn), 'tool_result' content type from user messages (merged into preceding assistant turn by tool_use_id), and 'tool_use' with 'id' field for matching. Session page shows all three collapsibly.", "created_at": "2026-02-22T10:16:32.878332+00:00"}
{"id": "b-cdce8871", "type": "fact", "text": "_get_live_session_path(cfg, agent_name): queries cfg.mux_db_path (~/.local/share/kg/mux.db) for agent's session_id, then globs ~/.claude/projects/*/<session_id>.jsonl to find the live Claude Code transcript. SSE stream watches both this live file (inotify MODIFY) and .kg/sessions/<agent>/ (archived at session end). [[kg-agent-mux]]", "created_at": "2026-02-22T10:16:38.697526+00:00"}
{"id": "b-69764733", "type": "gotcha", "text": "gotcha: Path is only imported under TYPE_CHECKING in web.py (from __future__ import annotations makes all annotations lazy strings). Any runtime use of Path.home() or Path() constructor inside function bodies requires 'from pathlib import Path as _Path' inside the function.", "created_at": "2026-02-22T10:16:42.800961+00:00"}
{"id": "b-251ac8bc", "type": "fact", "text": "Session page _parse_session(): tool_result entries from user messages merged into preceding assistant turn by tool_use_id. Each tool call dict now has id + optional result field. Tool results shown as collapsible green '\u21b3 result' blocks below each tool call.", "created_at": "2026-02-22T10:16:47.516747+00:00"}
{"id": "b-11deca46", "type": "fact", "text": "Claude Code session JSONL content types: user messages contain 'tool_result' items (tool_use_id + content str/list); assistant messages contain 'thinking' items (thinking field + signature) and 'tool_use' items (id + name + input dict). These are the actual runtime types \u2014 not just type annotations.", "created_at": "2026-02-22T10:16:50.379905+00:00"}
{"id": "b-172d75b4", "type": "fact", "text": "Session page: assistant turns show thinking blocks (type:'thinking' in content) as collapsed amber '\ud83d\udcad thinking (N chars)' sections. Assistant turns also get subtle left border (border-left:3px solid rgba(255,255,255,.12)) for visual parity with user turns.", "created_at": "2026-02-22T10:16:51.859995+00:00"}
{"id": "b-f870e6e9", "type": "fact", "text": "kg web mux_db_path: cfg.mux_db_path resolves to ~/.local/share/kg/mux.db (XDG_DATA_HOME/kg/mux.db), NOT the project-local .kg/index/mux.db. The mux server DB is user-level and shared across projects. This is where agent session_id is stored. [[kg-agent-mux]]", "created_at": "2026-02-22T10:16:54.474619+00:00"}
{"id": "b-575d9edd", "type": "fact", "text": "Live session streaming: _get_live_session_path(cfg, agent_name) queries mux DB (cfg.mux_db_path = ~/.local/share/kg/mux.db) for agent's current session_id, then globs ~/.claude/projects/*/<session_id>.jsonl to find the live Claude Code transcript. Requires 'from pathlib import Path as _Path' inside function body \u2014 Path is TYPE_CHECKING-only at module level. [[kg-stop-hook]]", "created_at": "2026-02-22T10:16:58.505837+00:00"}
{"id": "b-2f1f047c", "type": "fact", "text": "Claude projects path encoding: encoded = dash + abs_path.lstrip(slash).replace(slash, dash). For /workspace/kg/kg \u2192 -workspace-kg-kg. Use glob to find session file without hardcoding: projects_dir.glob(f'*/{session_id}.jsonl'). Same pattern as stop.py _find_session_cwd(). [[kg-stop-hook]]", "created_at": "2026-02-22T10:17:02.635258+00:00"}
{"id": "b-62ad5688", "type": "fact", "text": "_stream_agent_events() now watches THREE sources: (1) index dir for messages.db changes, (2) .kg/sessions/<agent>/ for archived sessions, (3) live Claude Code transcript dir via inotify MODIFY+CLOSE_WRITE. On _check(), also reads _get_live_session_path() and streams new bytes as 'thinking'+'turn' SSE events. [[kg-stop-hook]]", "created_at": "2026-02-22T10:17:08.556499+00:00"}
{"id": "b-92d287a7", "type": "gotcha", "text": "web.py gotcha: Path imported under TYPE_CHECKING only (annotations). Runtime Path.home() inside functions needs 'from pathlib import Path as _Path' locally. contextlib.suppress silently swallows NameError \u2192 function returns None silently.", "created_at": "2026-02-22T10:17:16.424137+00:00"}
{"id": "b-301e413d", "type": "fact", "text": "Agent archiving: archive button sets status='archived' in agent TOML (via update_agent_def). Archived agents hidden by default on /agents page \u2014 revealed with 'Show N archived' toggle. Archived cards shown greyed out (.ag-archived opacity:.45, dashed border). unarchive button resets to status='running'. [[kg-agent-launcher]]", "created_at": "2026-02-22T10:21:59.734830+00:00"}
{"id": "b-9aaf0eda", "type": "fact", "text": "POST /agents/create endpoint: creates new agent TOML (.kg/agents/<name>.toml) via create_agent_def(cfg, name, node='local', model=...). Name validated with [a-z0-9_-]+ regex. Form: name (required) + model (optional). Inline create form toggled by '+ New' button in agents page header. [[kg-agent-launcher]]", "created_at": "2026-02-22T10:22:04.677572+00:00"}
{"id": "b-7d630317", "type": "fact", "text": "Session page live streaming: _get_live_session_path(cfg, agent_name) queries mux DB for agent's session_id, then globs ~/.claude/projects/*/<session_id>.jsonl to find the live transcript during active Claude Code sessions. SSE streams from both archived .kg/sessions file and live ~/.claude file simultaneously. [[kg-agent-mux]]", "created_at": "2026-02-22T11:09:48.097752+00:00"}
{"id": "b-2a0545e6", "type": "fact", "text": "Session page turn rendering: tool results (from user messages with type='tool_result') merged into preceding assistant turns by tool_use_id. Thinking blocks (type='thinking') shown collapsed as '\ud83d\udcad thinking'. Tool results shown as '\u21b3 result' green-tinted. Both in collapsible <details> blocks.", "created_at": "2026-02-22T11:09:50.084339+00:00"}
{"id": "b-4fd7fa04", "type": "fact", "text": "Agent archiving: status='archived' in .kg/agents/<name>.toml. /agents page separates active vs archived agents; archived shown in collapsed section with dashed border + 45% opacity. POST /agent/<name>/ctrl with action=archive|unarchive toggles status. 'kg agents create' endpoint at POST /agents/create calls create_agent_def(). [[kg-agent-launcher]]", "created_at": "2026-02-22T11:09:54.117737+00:00"}
{"id": "b-45454d77", "type": "fact", "text": "Navigation improvements (rounds 7-8): agent cards on /agents page show KG node + mission links (checked via _get_slugs_db()); session page has breadcrumb 'agents / agent / KG node / mission'; node page has back link; agent page shows live session at top of sessions list when agent is running (mux DB session_id lookup). [[kg-agent-mux]]", "created_at": "2026-02-22T11:09:55.694131+00:00"}
{"id": "b-14a33fab", "type": "gotcha", "text": "(gotcha) Path in web.py is only imported under TYPE_CHECKING \u2014 runtime use of Path.home() etc. causes NameError. contextlib.suppress(Exception) silently swallows it, making functions return None. Fix: add 'from pathlib import Path as _Path' inside the function body at runtime.", "created_at": "2026-02-22T11:09:59.892580+00:00"}
{"id": "b-65033345", "type": "gotcha", "text": "_get_slugs_db() reads from graph.db \u2014 new nodes created outside kg CLI won't appear in web UI until kg reindex runs; _get_slugs_db() is used on every node page and search request", "created_at": "2026-02-22T11:15:41.117893+00:00"}
{"id": "b-17074a6d", "type": "gotcha", "text": "when KG/mission links don't appear on agent cards, check if agent nodes are indexed: sqlite3 .kg/index/graph.db 'SELECT slug FROM nodes WHERE slug LIKE \"agent-%\"'; fix by running kg reindex", "created_at": "2026-02-22T11:15:42.256440+00:00"}
{"id": "b-fe9193ef", "type": "gotcha", "text": "(gotcha) _get_slugs_db() queries graph.db (in .kg/index/) which only updates via the inotify watcher. New node directories created manually (kg add, kg agent create) are NOT automatically indexed \u2014 must run 'kg reindex' or wait for watcher to pick them up. If watcher isn't running, new slugs won't appear in link resolution.", "created_at": "2026-02-22T11:26:02.779450+00:00"}
{"id": "b-c12f27ff", "type": "fact", "text": "create-agent form: model selector is a <select> dropdown with Default(claude-sonnet-4-6), Sonnet 4.6, Opus 4.6, Haiku 4.5 options [[kg-development]]", "created_at": "2026-02-22T11:28:01.498676+00:00"}
{"id": "b-56e3a238", "type": "gotcha", "text": "_get_slugs_db() queries graph.db \u2014 nodes not in DB (e.g. unindexed new nodes) won't get KG/mission links on agent cards; fix with kg reindex [[kg-development]]", "created_at": "2026-02-22T11:28:13.342031+00:00"}
{"id": "b-9008dcf2", "type": "decision", "text": "tool call rendering pattern (round 9): result HTML placed INSIDE .tool-call div (not after it) so it stays visible when group is expanded; short results (\u2264120 chars, no newline) shown always-visible at bottom; long results get \u25b6 result (N chars) header inside same card [[agent-improve-web]]", "created_at": "2026-02-23T06:15:41.161133+00:00"}
{"id": "b-d88690e2", "type": "fact", "text": "shared _tog(btn) JS function in _GLOBAL_JS: toggles .open on btn.nextElementSibling; toggles \u25b6/\u25bc on .arr span inside btn. Used by tool-hdr, tool-result-hdr, tool-group-hdr, thinking-hdr. Arrow starts \u25b6 (collapsed) \u2192 \u25bc (expanded).", "created_at": "2026-02-23T06:15:51.359555+00:00"}
{"id": "b-1b0b9330", "type": "fact", "text": "/ keyboard shortcut for search: keydown listener in _GLOBAL_JS skips INPUT/TEXTAREA/contentEditable targets; calls document.querySelector('nav input[type=search]').focus()+select(). Works on all pages via global JS.", "created_at": "2026-02-23T06:15:57.446267+00:00"}
{"id": "b-8ff3a1db", "type": "fact", "text": "agent link detection in _agent_link_for_node: checks (1) node_type=='agent', (2) slug ends with -mission/-instructions/-knowledge (strip suffix, then optionally strip 'agent-' prefix), (3) slug starts with 'agent-' (strip prefix). Each case checks TOML file exists before emitting link.", "created_at": "2026-02-23T06:16:03.626034+00:00"}
{"id": "b-ef8d9547", "type": "fact", "text": "live-feed placeholder: when rt\\!='running', #live-feed div shown by default (not display:none) with #live-placeholder <p> saying 'Activity appears here when a session is running.'; when running, feed hidden with 'Waiting for activity\u2026'. SSE thinking/turn events call ph.remove() to clear placeholder before inserting content.", "created_at": "2026-02-23T06:16:10.137076+00:00"}
{"id": "b-026b1eae", "type": "fact", "text": "session list collapsing: show 5 most recent sessions on agent page by default (_SESS_SHOW=5); older sessions in hidden #sess-older div with 'Show N older sessions' toggle link. Live session always shown at top regardless.", "created_at": "2026-02-23T06:16:16.194604+00:00"}
{"id": "b-b18896c3", "type": "fact", "text": "_tool_summary() extended: WebSearch\u2192query, TodoWrite\u2192'N items \u00b7 M active \u00b7 K done', AskUserQuestion\u2192first question text, NotebookEdit\u2192notebook_path, send_message\u2192'\u2192 agent \u00b7 body[:30]', get_pending_messages\u2192'inbox', Grep shows glob filter if present", "created_at": "2026-02-23T06:16:25.642263+00:00"}
{"id": "b-3cd70c68", "type": "fact", "text": "SSE replay on connect: _stream_agent_events() now replays last 50 turns from current session JSONL (live path preferred, falls back to sessions_dir latest). Sends has-older event with count if more exist. JS shows load-older button fetching /agent/name/older-turns?skip=N in batches of 50. Prevents blank live-feed on page reload. [[agent-improve-web]]", "created_at": "2026-02-23T19:43:04.745649+00:00"}
