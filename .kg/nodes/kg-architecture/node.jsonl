{"v": 1, "slug": "kg-architecture", "title": "kg-architecture", "type": "concept", "created_at": "2026-02-20T08:31:05.434653+00:00"}
{"id": "b-1dab7d6b", "type": "decision", "text": "meta.json replaces meta.jsonl: single JSON file per node, RMW under flock (LOCK_SH read, LOCK_EX write), atomic write via .json.tmp + rename", "created_at": "2026-02-20T08:31:05.434824+00:00"}
{"id": "b-1792b87b", "type": "fact", "text": "meta.json structure: {token_budget, last_reviewed, last_bullet_checkpoint, bullets: {id: {useful, harmful, used}}}", "created_at": "2026-02-20T08:31:09.008026+00:00"}
{"id": "b-3fff8731", "type": "fact", "text": "migrate legacy meta.jsonl on first access: read all lines, merge into meta.json structure, delete legacy file after successful write", "created_at": "2026-02-20T08:31:12.565153+00:00"}
{"id": "b-b14f5123", "type": "decision", "text": "(decision) only the inotify watcher writes to SQLite \u2014 CLI commands (kg add, kg review) write JSONL only [[kg-stop-hook]]", "created_at": "2026-02-20T08:31:16.456699+00:00", "updated_at": "2026-02-20T10:51:06.778015+00:00"}
{"id": "b-1b2e195e", "type": "fact", "text": "kg start creates <project>/.claude -> .kg symlink (ensure_dot_claude_symlink) \u2014 same pattern as mg .claude -> .memory_graph; lets Claude Code find local settings/commands in .kg/", "created_at": "2026-02-20T08:33:42.880182+00:00"}
{"id": "b-96a7b5b3", "type": "fact", "text": "legacy meta.jsonl files auto-deleted after migration to meta.json \u2014 _migrate_legacy_meta() calls legacy.unlink() after writing meta.json", "created_at": "2026-02-20T08:33:48.451631+00:00"}
{"id": "b-262a15b1", "type": "fact", "text": "MCP server uses FastMCP (mcp.run()). Registered with --root <project_root> arg so server finds kg.toml regardless of invocation cwd. Server name 'kg'.", "created_at": "2026-02-20T08:37:16.561158+00:00"}
{"id": "b-1443d426", "type": "fact", "text": "kg start creates <project>/.claude \u2192 .kg symlink (same pattern as mg's .claude \u2192 .memory_graph). Lets Claude Code discover skills/settings in .kg/ when running inside the project dir.", "created_at": "2026-02-20T08:37:17.233509+00:00"}
{"id": "b-30df318f", "type": "fact", "text": "vote_score() Beta prior: (useful + alpha) / (useful + harmful*harmful_weight + alpha + beta). Defaults: alpha=2, beta=2, harmful_weight=2 (neutral=0.5, harmful counts double). Rank multiplier = score*2.0 so neutral\u21921.0x.", "created_at": "2026-02-20T08:37:17.830729+00:00"}
{"id": "b-2246f6c6", "type": "fact", "text": "memory_context MCP tool tracks _seen_slugs process-wide; subsequent calls filter already-seen nodes (differential context). fresh=True resets, existing=[...] seeds from caller. Matches mg pattern.", "created_at": "2026-02-20T08:37:18.467532+00:00"}
{"id": "b-b5403b2d", "type": "gotcha", "text": "cfg.kg_dir property missing from KGConfig \u2014 install.py ensure_dot_claude_symlink uses cfg.kg_dir.resolve() but only index_dir.parent exists as a local var. Fix: add @property kg_dir returning self.index_dir.parent", "created_at": "2026-02-20T08:40:08.977646+00:00"}
{"id": "b-1b2e195e", "deleted": true}
{"id": "b-4b2a7d23", "type": "fact", "text": "kg create <slug> <title> [--type]: creates node with explicit title (defaults to slug in kg add). Idempotent \u2014 exits 0 if already exists. Needed for daily notes nodes like 'Notes 2026-02-20'.", "created_at": "2026-02-20T08:45:23.894884+00:00"}
{"id": "b-2be2585d", "type": "fact", "text": ".claude \u2192 .kg symlink: kg start calls ensure_dot_claude_symlink(cfg) to create <project_root>/.claude \u2192 .kg. Lets Claude Code find skills/settings at .kg/ when working in the project.", "created_at": "2026-02-20T08:45:24.513903+00:00"}
{"id": "b-b4df42db", "type": "gotcha", "text": "cfg.kg_dir property missing from KGConfig: install.py references cfg.kg_dir but it's not defined \u2014 workaround is cfg.index_dir.parent. PENDING: add @property kg_dir to KGConfig.", "created_at": "2026-02-20T08:45:25.120569+00:00"}
{"id": "b-b4df42db", "deleted": true}
{"id": "b-01d6154e", "type": "fact", "text": "local embeddings: model = \"fastembed:BAAI/bge-small-en-v1.5\" in [embeddings] \u2014 no API key needed, pip install fastembed, 384-dim ONNX. Prefix \"gemini:\" for Gemini, \"fastembed:\" or bare name for local.", "created_at": "2026-02-20T09:04:10.177647+00:00"}
{"id": "b-4d798205", "type": "fact", "text": "embedding failure transparency: _embed_node warns to stderr on exception (no silent contextlib.suppress); vector_server exits at startup if Gemini model + no GEMINI_API_KEY/GOOGLE_API_KEY", "created_at": "2026-02-20T09:04:14.427842+00:00"}
{"id": "b-a9f5de78", "type": "gotcha", "text": "inotify-simple gated to sys_platform==\"linux\" in pyproject.toml \u2014 inotify is Linux-only; watcher falls back to polling on macOS/Windows. Bare dep without marker causes install failure on non-Linux.", "created_at": "2026-02-20T09:07:23.110373+00:00"}
{"id": "b-cada8bb0", "type": "fact", "text": "pyproject.toml core deps: click, diskcache, fastembed, fastmcp, google-genai, inotify-simple (linux only), numpy, rich. No separate optional extras needed \u2014 all embedding/watch deps are in core.", "created_at": "2026-02-20T09:07:29.914021+00:00"}
{"id": "b-c17920d0", "type": "fact", "text": "fastcdc vendored as src/kg/_vendor/fastcdc/ package: __init__.py tries Cython (fastcdc_cy.pyx \u2192 .so), falls back to pure Python (fastcdc_py.py). setup.py with BuildExtWithFallback ensures graceful fallback when Cython unavailable.", "created_at": "2026-02-20T09:17:49.635978+00:00"}
{"id": "b-b56f1636", "type": "fact", "text": "pyproject.toml build backend: setuptools (not hatchling) when using Cython extensions. Requires build-system = {requires=[setuptools>=61.0, wheel, cython>=3.0], build-backend=setuptools.build_meta}.", "created_at": "2026-02-20T09:17:57.572597+00:00"}
{"id": "b-be18171e", "type": "decision", "text": "fastcdc chunk sizes: kg uses avg=1500B (min=375B, max=12000B) for FTS-based search; mg uses avg=4096B for LLM context windows. Intentional difference \u2014 smaller chunks improve FTS recall.", "created_at": "2026-02-20T09:18:02.938345+00:00"}
{"id": "b-844128d6", "type": "gotcha", "text": "(gotcha) fastcdc_cy returns an iterator (generator), not a list \u2014 calling len() on its result fails. file_indexer only iterates chunks, so compatible. Don't call len() directly on fastcdc output.", "created_at": "2026-02-20T09:18:09.707599+00:00"}
{"id": "b-15d9b872", "type": "fact", "text": "kg status validates kg.toml at runtime: embeddings (gemini:/fastembed:/openai: prefix + API key presence), sources (path exists, git repo check when use_git=true) \u2014 shows Config row with kg.toml path", "created_at": "2026-02-20T09:31:50.017811+00:00"}
{"id": "b-0f66dc97", "type": "fact", "text": "watcher SIGHUP hot-reload: _reload_state=[False] mutable container (avoids PLW0603 global); SIGHUP handler sets [0]=True; loop checks after each inotify timeout (5s) or poll cycle (1s); raises _ReloadRequestedError; run_from_config loops to re-read kg.toml", "created_at": "2026-02-20T09:31:52.951867+00:00"}
{"id": "b-0c216d33", "type": "fact", "text": "kg reload command: sends SIGHUP to watcher via PID file (os.kill(pid, SIGHUP)) or supervisord (supervisorctl signal HUP kg-watcher). Watcher reloads within 1-5s without restart.", "created_at": "2026-02-20T09:31:57.797024+00:00"}
{"id": "b-a580be01", "type": "fact", "text": "embedding model prefixes in kg.toml [embeddings].model: gemini:* (cloud, needs GEMINI_API_KEY/GOOGLE_API_KEY), openai:* (cloud, needs OPENAI_API_KEY), fastembed:* or bare name (local, no key). Unknown prefix warns in kg status.", "created_at": "2026-02-20T09:32:00.064394+00:00"}
{"id": "b-9466d54d", "type": "gotcha", "text": "Rich markup gotcha: [[sources]] in a table cell is parsed as markup (unknown tag stripped). Fix: rich.markup.escape('[[sources]]') for literal display, or use \\[ escaping.", "created_at": "2026-02-20T09:32:03.847483+00:00"}
{"id": "b-3322d3fa", "type": "gotcha", "text": "ruff N818: Exception subclass names must end with 'Error' suffix (e.g. _ReloadRequestedError not _ReloadRequested). ruff PLW0603: 'global' to mutate module var is discouraged \u2014 use mutable container like list[bool] instead.", "created_at": "2026-02-20T09:32:11.392923+00:00"}
{"id": "b-42cddcc5", "type": "fact", "text": "kg web viewer perf: index+slugs from DB (not file scan), Related section lazy-loaded via JS fetch [[kg-web]]", "created_at": "2026-02-20T09:58:28.530206+00:00", "updated_at": "2026-02-20T10:51:13.039336+00:00"}
{"id": "b-3ba4dcef", "type": "fact", "text": "(decision) cross-reference syntax changed from [slug] to [[slug]] (double brackets) throughout codebase \u2014 indexer.py, context.py, transcript.py, web.py, cli.py, hooks/stop.py all updated. Single-bracket [slug] is now legacy.", "created_at": "2026-02-20T10:49:59.867587+00:00"}
{"id": "b-e0efe425", "type": "fact", "text": "kg show / kg nodes show: falls back to reading _doc-* nodes from SQLite when not found in FileStore (filesystem). _node_from_db() helper in cli.py performs this fallback lookup.", "created_at": "2026-02-20T10:50:03.843025+00:00"}
{"id": "b-5164f5e3", "type": "fact", "text": "kg add auto-creates stub nodes for any [[slug]] refs in bullet text that do not exist yet \u2014 ensures backlinks are always navigable without manual kg create step.", "created_at": "2026-02-20T10:50:10.064825+00:00"}
{"id": "b-72f692de", "type": "fact", "text": "kg migrate-refs command: rewrites [slug] to [[slug]] in all node.jsonl bullet text, then reindexes to rebuild backlinks table. Migration path for existing graphs to adopt double-bracket syntax.", "created_at": "2026-02-20T10:50:15.050173+00:00"}
{"id": "b-ebfe8c8e", "type": "fact", "text": "(gotcha) kg upgrade runs old binary code for its reindex step \u2014 doc node indexing fix (index_source for file sources) only takes effect when user runs kg reindex with the new binary afterward. Must document in release notes.", "created_at": "2026-02-20T10:50:19.705412+00:00"}
{"id": "b-9b18a8de", "type": "fact", "text": "kg reindex and kg upgrade now call index_source for file sources after rebuild_all \u2014 previously only node.jsonl files were processed, leaving doc nodes (_doc-*) unindexed after a reindex.", "created_at": "2026-02-20T10:50:24.617591+00:00"}
{"id": "b-7fe2f054", "type": "fact", "text": "kg status now shows version via importlib.metadata \u2014 displays installed package version in status output alongside config validation.", "created_at": "2026-02-20T10:50:29.795701+00:00"}
{"id": "b-3bc11742", "type": "decision", "text": "[[slug]] double-bracket syntax for cross-references (changed from [slug]). All regexes updated: indexer._CROSSREF_RE, context._CROSSREF_RE, web._SLUG_RE, transcript._slug_re, cli add command. Migration: kg migrate-refs rewrites node.jsonl files then reindexes backlinks.", "created_at": "2026-02-20T10:56:33.887799+00:00"}
{"id": "b-6fd5ca61", "type": "fact", "text": "kg show / kg nodes show: falls back to SQLite (_node_from_db) when FileStore.get() returns None. Needed for _doc-* nodes which live only in the index, not on the filesystem [[kg-web]]", "created_at": "2026-02-20T10:56:40.694514+00:00"}
{"id": "b-36385fbe", "type": "fact", "text": "kg add auto-creates stub nodes for any [[slug]] cross-refs in bullet text that don't exist yet. Stub has 0 bullets but gets backlinks indexed immediately \u2014 navigable from day one.", "created_at": "2026-02-20T10:56:46.527803+00:00"}
{"id": "b-47f8100d", "type": "gotcha", "text": "(gotcha) kg upgrade runs reindex using OLD binary's code \u2014 fixed in 0.3.27 to subprocess out to new binary (shutil.which('kg')). Before 0.3.27: run kg reindex manually after kg upgrade.", "created_at": "2026-02-20T10:56:51.367289+00:00"}
{"id": "b-aa5a5ea5", "type": "gotcha", "text": "(gotcha) kg reindex and kg upgrade previously skipped index_source for [[sources]] entries \u2014 only rebuilt node.jsonl nodes. Fixed in 0.3.25. Before that, doc nodes never appeared after fresh install/upgrade; kg nodes --docs was empty.", "created_at": "2026-02-20T10:56:57.174430+00:00"}
{"id": "b-5db6614f", "type": "decision", "text": "FTS calibration: separate keys 'fts' (concept bullets, type \\!= chunk) and 'fts_doc' (doc chunks, type = chunk). BM25 penalises long documents \u2014 chunks score lower than short bullets. Mixed calibration breaks doc ranking. Fixed in 0.3.27.", "created_at": "2026-02-20T10:57:02.961325+00:00"}
{"id": "b-6e9a4a29", "type": "gotcha", "text": "calibrate() must run AFTER index_source \u2014 not between rebuild_all and index_source. If calibration runs before chunks are indexed, fts_doc calibration gets no samples and doc search scores default to 0.", "created_at": "2026-02-20T10:57:07.752850+00:00"}
{"id": "b-92214b98", "type": "fact", "text": "kg status shows Version row (importlib.metadata.version('kg')). Calibration shows 'FTS bullets' and 'FTS docs' rows separately. Sources section shows indexed file stats (files \u00b7 chunks \u00b7 KB \u00b7 top-3 extensions).", "created_at": "2026-02-20T10:57:13.002272+00:00"}
