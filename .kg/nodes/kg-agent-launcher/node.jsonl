{"v": 1, "slug": "kg-agent-launcher", "title": "kg-agent-launcher", "type": "concept", "created_at": "2026-02-22T06:25:24.750027+00:00"}
{"id": "b-ef11b376", "type": "decision", "text": "Launcher is a per-node process supervisor separate from mux. Reads .kg/agents/<name>.toml (one TOML per agent, git-tracked). Manages only agents with node==KG_NODE_NAME. Kills agents reallocated to other nodes. CLI: kg launcher start/stop/status/agent. [[kg-agent-mux]] [[agent-delegation]]", "created_at": "2026-02-22T06:25:24.750342+00:00"}
{"id": "b-53744b25", "type": "fact", "text": "Agent definition files at .kg/agents/<name>.toml: fields name, node, auto_start, restart (always/on-failure/never), wake_on_message, model, working_dir. One file per agent, git-tracked. Created by 'kg mux agent create <name> --node <node>'. Launcher reads all .kg/agents/*.toml on its node.", "created_at": "2026-02-22T06:25:29.264279+00:00"}
{"id": "b-a8a3cb18", "type": "decision", "text": "Pull-based node migration: change .kg/agents/alice.toml node= field + git commit + push. Launcher on old node sees node!=own \u2192 kills alice. Launcher on new node sees node==own \u2192 starts alice. No coordination between launchers needed.", "created_at": "2026-02-22T06:25:33.459508+00:00"}
{"id": "b-59f4b0dc", "type": "fact", "text": "Launcher._launch() runs: KG_AGENT_NAME=<name> claude --dangerously-skip-permissions [--resume <prev_session_id> --fork-session] --print '<prompt>' (headless, no TTY). Resumes prior session if session_id in mux DB (_get_prev_session_id()). prompt= from AgentDef.prompt or _DEFAULT_PROMPT. CLAUDECODE env var unset for nested launch. ANTHROPIC_MODEL env set if model field set. stdout/stderr to DEVNULL. rc=0 \u2192 restart_count reset to 0 (no backoff accumulation). [[kg-agent-mux]]", "created_at": "2026-02-22T06:25:38.091437+00:00", "updated_at": "2026-02-22T08:51:42.032964+00:00"}
{"id": "b-c68f38d1", "type": "fact", "text": "Restart backoff: exponential base = min(2^restart_count, 60s) with \u00b120% jitter. restart='always' \u2192 always restart. 'on-failure' \u2192 restart only on non-zero exit. 'never' \u2192 leave idle. Backoff tracked per ManagedAgent.next_start_after (monotonic).", "created_at": "2026-02-22T06:25:42.451049+00:00"}
{"id": "b-dd1e1e26", "type": "fact", "text": "wake_on_message: idle agents auto-started when pending-count > 0. Launcher calls GET /agent/<name>/pending-count (non-destructive, counts both normal+urgent undelivered). Only fires if proc is None + not in backoff. Default true in TOML. [[kg-agent-mux]]", "created_at": "2026-02-22T06:25:46.381018+00:00", "updated_at": "2026-02-22T07:16:12.859129+00:00"}
{"id": "b-f4bf63a4", "type": "fact", "text": "Launcher runs git pull --rebase --autostash in cfg.root on every poll cycle to pick up new agent TOML allocations. Failure is silently swallowed (offline/no remote is fine).", "created_at": "2026-02-22T06:25:50.826089+00:00"}
{"id": "b-34ab8886", "type": "fact", "text": "PID files: launcher PID now per-instance at <root>/.kg/.launcher.pid (was global ~/.local/share/kg/.launcher.pid \u2014 FIXED). Log is project-local at .kg/logs/launcher.log. stop_background(cfg)/launcher_status(cfg) both require cfg arg now.", "created_at": "2026-02-22T06:25:55.101846+00:00", "updated_at": "2026-02-23T19:42:35.462777+00:00"}
{"id": "b-7e66566e", "type": "fact", "text": "AgentDef.status field (running | paused | draining): 'paused' \u2192 launcher terminates agent immediately and does NOT restart; 'draining' \u2192 launcher lets agent finish current session, does NOT restart on exit; 'running' (default) \u2192 normal restart policy applies. Only written to TOML when non-default.", "created_at": "2026-02-22T06:30:50.991799+00:00"}
{"id": "b-908e14c1", "type": "fact", "text": "kg launcher agent subcommands: 'pause <name>' \u2192 writes status=paused to TOML; 'resume <name>' \u2192 writes status=running; 'drain <name>' \u2192 writes status=draining; 'migrate <name> --to <node>' \u2192 atomically changes node + status=running in TOML (old node kills, new node starts). --drain flag on migrate sets status=draining first and prints follow-up command for when agent stops.", "created_at": "2026-02-22T06:30:55.835485+00:00"}
{"id": "b-551e6060", "type": "fact", "text": "update_agent_def(cfg, name, **kwargs) helper reads .kg/agents/<name>.toml into AgentDef, patches any fields with setattr, rewrites via toml_str(). Used by all launcher agent subcommands. Raises FileNotFoundError if TOML missing.", "created_at": "2026-02-22T06:30:57.848500+00:00"}
{"id": "b-a9dc4534", "type": "fact", "text": "Launcher._sync_definitions() status handling: if status==paused and proc running \u2192 _terminate immediately; if status==paused or draining \u2192 skip auto_start; _reap_and_restart() skips restart if status in (paused, draining); _wake_on_message() skips if status != running; _launch() short-circuits if status != running.", "created_at": "2026-02-22T06:31:02.377610+00:00"}
{"id": "b-81955421", "type": "note", "text": "Two-layer file watching for launcher TOML changes (IMPLEMENTED): (1) inotify_simple watches .kg/agents/ dir \u2014 on any .toml change immediately calls _sync_definitions()+_reap_and_restart()+_wake_on_message(); (2) git pull at poll_interval (default 30s) for remote TOML changes. Falls back to pure polling (_run_poll) if inotify_simple unavailable. KG_LAUNCHER_POLL env var overrides poll interval (CLI --poll takes precedence if > 0).", "created_at": "2026-02-22T06:31:04.946977+00:00", "updated_at": "2026-02-22T06:48:00.994503+00:00"}
{"id": "b-c37ff46a", "type": "gotcha", "text": "wake_on_message REQUIRES kg launcher to be running \u2014 if launcher is not running, messages queue in mux but agent is never started. Launcher must be started separately with 'kg launcher start -d'.", "created_at": "2026-02-22T07:13:26.370856+00:00"}
{"id": "b-55ee428c", "type": "fact", "text": "Launcher starts agents as headless subprocesses (stdout/stderr=DEVNULL). Not an interactive terminal. For interactive session use 'kg run <name>' which opens claude directly in terminal.", "created_at": "2026-02-22T07:13:26.953418+00:00"}
{"id": "b-e2e783ea", "type": "fact", "text": "Agent responses in headless mode: agent sends back messages via send_message MCP tool \u2192 they appear in web UI thread. Not real-time chat \u2014 async message exchange.", "created_at": "2026-02-22T07:13:27.544706+00:00"}
{"id": "b-585912fc", "type": "fact", "text": "sessions_sync=true in [agents] config: Stop hook git-adds + git-commits session transcript to .kg/sessions/<agent>/<id>.jsonl after archiving locally. Default false (opt-in).", "created_at": "2026-02-22T07:13:36.619202+00:00"}
{"id": "b-cbc73ba4", "type": "fact", "text": "kg run <name>: convenience wrapper that sets KG_AGENT_NAME=<name>, reads .kg/agents/<name>.toml for model/working_dir, then exec's 'claude'. --unsafe adds --dangerously-skip-permissions. Interactive terminal session.", "created_at": "2026-02-22T07:13:43.118511+00:00"}
{"id": "b-a1a4e6ca", "type": "fact", "text": "wake_on_message: launcher calls GET /agent/<name>/pending-count (non-destructive) every poll cycle. If count > 0 and agent is idle and not in backoff, launches it. Counts both normal and urgent undelivered messages. Previously used /pending which was destructive AND missed urgent messages. [[kg-agent-mux]]", "created_at": "2026-02-22T07:20:26.715341+00:00"}
{"id": "b-0694976a", "type": "fact", "text": "Web /agent/<name> page: shows idle banner with 'kg launcher start' hint + 'kg run <name>' fallback when rt != 'running'. Banner has id='ag-idle-banner', info bar has id='ag-info-bar' \u2014 both updated by 8s JS auto-refresh (fetch+DOMParser) so status changes appear without full reload. [[kg-web]]", "created_at": "2026-02-22T07:20:27.264173+00:00"}
{"id": "b-905e6c84", "type": "fact", "text": "kg agent create <name>: registers in mux.db (idle status) + writes .kg/agents/<name>.toml (auto_start=true, wake_on_message=true, restart=always) + creates KG nodes agent-<name>-instructions and agent-<name>. Requires agents.enabled=true. 'kg agent' is top-level alias for 'kg mux agent'. [[kg-agent-mux]]", "created_at": "2026-02-22T07:24:54.230895+00:00"}
{"id": "b-e4dda13d", "type": "gotcha", "text": "env.pop(\"CLAUDECODE\", None) required before launching claude subprocess \u2014 claude refuses to start if CLAUDECODE env var is set (nested session protection)", "created_at": "2026-02-22T07:40:53.153994+00:00"}
{"id": "b-34322240", "type": "decision", "text": "launcher log moved to .kg/logs/launcher.log (project-local); was ~/.local/share/kg/launcher.log", "created_at": "2026-02-22T07:40:57.580000+00:00"}
{"id": "b-08d4d714", "type": "fact", "text": "inotify watches both .kg/agents/*.toml AND .kg/index/ \u2014 messages.db CLOSE_WRITE triggers immediate _wake_on_message() without waiting for poll", "created_at": "2026-02-22T07:41:03.297534+00:00"}
{"id": "b-5ef3b30f", "type": "gotcha", "text": "_has_pending_messages() uses /agent/<name>/pending-count endpoint (non-destructive); old /pending endpoint had side-effect of marking messages as delivered", "created_at": "2026-02-22T07:41:07.826404+00:00"}
{"id": "b-b5629ef4", "type": "gotcha", "text": "CLAUDECODE env var crash: if launcher inherits CLAUDECODE=1 from parent session, claude refuses to start with 'cannot be launched inside another Claude Code session'. Fix: env.pop('CLAUDECODE', None) in _launch() and agent_run_cmd. [[kg-development]]", "created_at": "2026-02-22T07:48:58.375751+00:00"}
{"id": "b-b119e341", "type": "fact", "text": "AgentDef.prompt field: optional startup prompt passed to claude --print. Default (AgentDef._DEFAULT_PROMPT): 'You are an autonomous agent. Check session context for pending messages and respond via send_message MCP tool. When done, stop.' Set prompt= in .kg/agents/<name>.toml to customize.", "created_at": "2026-02-22T07:49:03.532779+00:00"}
{"id": "b-d8318b3e", "type": "fact", "text": ".kg/.gitignore should ignore: index/, logs/, messages/, sessions/ \u2014 these are all derived/runtime and should not be git-tracked. .kg/agents/*.toml and .kg/nodes/ are git-tracked.", "created_at": "2026-02-22T07:49:07.714020+00:00"}
{"id": "b-ae051af8", "type": "fact", "text": "inotify wake on message: launcher watches .kg/index/ for CLOSE_WRITE on messages.db \u2014 any new message immediately triggers _wake_on_message() without waiting for poll cycle. Complements inotify watch on .kg/agents/ for TOML changes. [[kg-agent-mux]]", "created_at": "2026-02-22T07:49:13.241017+00:00"}
{"id": "b-c9e1354c", "type": "gotcha", "text": "(gotcha) When agent working dir is inside a larger workspace (e.g., /workspace/kg/kg inside /workspace), Claude Code picks up the parent /workspace/.mcp.json first if /workspace/kg/kg/.mcp.json doesn't exist. Launcher must ensure .mcp.json exists at the kg root pointing to that root \u2014 or use kg start --scope local to write it.", "created_at": "2026-02-22T07:59:53.336770+00:00"}
{"id": "b-37ab4a77", "type": "gotcha", "text": "gotcha: restart='always' + auto_start=true causes agent to launch immediately even with no pending messages. For message-processing agents, use restart='on-failure' (or 'never') + auto_start=false; wake_on_message=true handles waking when messages arrive", "created_at": "2026-02-22T08:01:28.141979+00:00"}
{"id": "b-ddc70e8a", "type": "fact", "text": "AgentDef.prompt field: per-agent custom startup prompt in TOML. _DEFAULT_PROMPT: 'You are an autonomous agent. Check your session context for pending messages and respond to each one. Use the send_message MCP tool to reply. When done, stop.' Best practice: prompt should mention '=== AGENT MESSAGES ===' format and instruct agent to exit if no messages found", "created_at": "2026-02-22T08:01:38.013230+00:00"}
{"id": "b-0a93858e", "type": "fact", "text": "fact: get_pending_messages() MCP tool in mcp.py calls /agent/{name}/session-start to fetch all pending messages (normal+urgent) \u2014 agent should call this before stopping to catch messages that arrived during processing", "created_at": "2026-02-22T08:30:42.204467+00:00"}
{"id": "b-a4d27593", "type": "fact", "text": "fact: default --print agent prompt is a 5-step loop: (1) check session context, (2) call get_pending_messages(), (3) reply via send_message, (4) call get_pending_messages() again, (5) stop when inbox empty", "created_at": "2026-02-22T08:30:45.260220+00:00"}
{"id": "b-1aa78d57", "type": "gotcha", "text": "gotcha: in --print mode SessionStart hook fires and injects context; PostToolUse heartbeat also fires after each tool call; race: message arrives after last tool call but before Stop \u2014 fix is get_pending_messages() at end + urgent_session_delivered ack semantics [[kg-agent-mux]]", "created_at": "2026-02-22T08:30:49.596306+00:00"}
{"id": "b-4d173a72", "type": "fact", "text": "Session resume: _launch() reads previous session_id from mux.db. If found, uses 'claude --resume <id> --fork-session --print <prompt>' \u2014 agent inherits full conversation context. --fork-session creates a new session ID (so it can be resumed again next time). Gives agents memory of prior messages sent/received. [[kg-agent-mux]]", "created_at": "2026-02-22T08:34:21.074746+00:00"}
{"id": "b-c618c533", "type": "fact", "text": "Launcher --resume --fork-session: _launch() now calls _get_prev_session_id() to look up session_id from mux DB. If found, uses 'claude --resume <id> --fork-session --print <prompt>' for session continuity. fork-session gives new session ID while inheriting prior context. Falls back to bare --print if no prior session. [[kg-agent-mux]]", "created_at": "2026-02-22T08:41:17.829782+00:00"}
{"id": "b-26705b7e", "type": "gotcha", "text": "Backoff reset on clean exit: restart_count resets to 0 and next_start_after to 0.0 when agent exits rc=0. Prevents exponential backoff from accumulating across successful processing runs. Without this, an agent that processes messages and exits cleanly would wait 17s+ before waking for the next message after 4 runs. [[kg-agent-mux]]", "created_at": "2026-02-22T08:41:22.460960+00:00"}
{"id": "b-76cd3217", "type": "fact", "text": "Default startup prompt updated: now instructs agent to (1) check session context, (2) call get_pending_messages() to fetch additional msgs, (3) reply via send_message, (4) call get_pending_messages() again before stopping, (5) stop when empty. Prevents missed messages due to SessionStart/heartbeat race. [[kg-agent-mux]]", "created_at": "2026-02-22T08:41:27.124787+00:00"}
{"id": "b-443736c1", "type": "fact", "text": "Session resume: launcher uses --resume <prev_session_id> --fork-session --print <prompt> when a prior session_id exists in mux.db. --fork-session gives a new session ID while inheriting the previous context. session_id stored in agents table, updated by SessionStart hook each run. Gives agents memory across sessions.", "created_at": "2026-02-22T08:50:55.365972+00:00"}
{"id": "b-d46a66e1", "type": "gotcha", "text": "Backoff reset on clean exit: launcher resets restart_count=0 and next_start_after=0.0 when agent exits rc=0. Prevents backoff accumulation for healthy agents that repeatedly process-and-exit. Backoff only applies to crash restarts (rc!=0). Without this fix, wake_on_message is blocked by growing backoff even for healthy runs.", "created_at": "2026-02-22T08:51:00.482360+00:00"}
{"id": "b-b4fa3729", "type": "gotcha", "text": "(gotcha) 'kg launcher agent' has NO start or stop subcommands \u2014 to enable an agent to run use 'kg launcher agent resume <name>'. Subcommands are only: drain, migrate, pause, resume. To start/stop the launcher daemon itself use 'kg launcher start/stop'.", "created_at": "2026-02-22T09:06:07.598360+00:00"}
{"id": "b-1c85196b", "type": "fact", "text": "(gotcha) restart_count must reset to 0 on rc=0 (clean exit) \u2014 without reset it accumulates across normal exits, causing wake_on_message to block on exponentially growing backoff even when agent exits cleanly [[kg-agent-mux]]", "created_at": "2026-02-22T09:07:50.149250+00:00"}
{"id": "b-b93848c2", "type": "fact", "text": "agent creation workflow: 'kg mux agent create <name>' creates KG node pair (agent-<name>-instructions + agent-<name>) + registers in mux.db + writes .kg/agents/<name>.toml. Launcher manages the agent once TOML exists. 'kg launcher agent resume <name>' activates from paused/idle. [[kg-agent-mux]]", "created_at": "2026-02-22T09:09:39.972232+00:00"}
{"id": "b-0778070c", "type": "gotcha", "text": "gotcha: agent registered in mux.db but missing .kg/agents/<name>.toml \u2014 launcher ignores it. Messages queue in mux unread. Fix: create TOML manually or via 'kg mux agent create <name>' which writes the TOML. Human-operated pseudo-agents (like 'web') typically have no TOML. [[kg-agent-mux]]", "created_at": "2026-02-22T09:09:44.658449+00:00"}
{"id": "b-48e40625", "type": "fact", "text": "Default agent prompt (5 steps): (1) check session context for injected messages, (2) call get_pending_messages() for additional arrivals, (3) reply via send_message(to_agent=sender), (4) call get_pending_messages() once more before stopping, (5) stop when inbox empty.", "created_at": "2026-02-22T09:33:59.483415+00:00"}
{"id": "b-6533282a", "type": "fact", "text": "rc=0 resets restart_count=0 and next_start_after=0 in _reap_and_restart(). Prevents backoff accumulation on healthy agents that exit cleanly after processing messages.", "created_at": "2026-02-22T09:34:03.716996+00:00"}
{"id": "b-ad8f8322", "type": "fact", "text": "Session resume: launcher stores session_id in mux.db agents table (set by SessionStart hook). Next launch uses --resume <prev_session_id> (no --fork-session) so each agent has one growing transcript with full conversation memory. _get_prev_session_id() reads from mux.db.", "created_at": "2026-02-22T09:36:15.909533+00:00"}
{"id": "b-07b8a03e", "type": "fact", "text": "rc=0 backoff reset: when agent exits with rc=0 (clean), restart_count is reset to 0 and next_start_after to 0.0. Prevents backoff accumulation for agents that repeatedly exit cleanly (normal --print mode behavior). Backoff only grows on crash exits (rc!=0).", "created_at": "2026-02-22T09:36:22.934926+00:00"}
{"id": "b-59f4b0dc", "deleted": true}
{"id": "b-31e7c5b0", "type": "decision", "text": "session resume: launcher uses resume flag with prev_session_id plus print flag (no --fork-session) for growing transcript memory continuity. _get_prev_session_id() reads session_id from mux.db. --fork-session caused duplicate messages in inboxes.", "created_at": "2026-02-22T09:42:50.424819+00:00"}
{"id": "b-6178401a", "type": "fact", "text": "rc=0 backoff reset: _reap_and_restart() sets restart_count=0 and next_start_after=0.0 on clean exit (rc==0). Prevents accumulated backoff from blocking wake_on_message when agent exits cleanly between messages.", "created_at": "2026-02-22T09:42:54.488475+00:00"}
{"id": "b-25bf6568", "type": "decision", "text": "TOML restart policy: use restart='on-failure' + wake_on_message=true for event-driven agents. restart='always' causes 1-second restart loop on clean exit (rc=0 \u2192 restart_count resets \u2192 1s backoff \u2192 restart). 'on-failure' only restarts on crash; new messages wake via wake_on_message.", "created_at": "2026-02-22T09:59:20.054037+00:00"}
{"id": "b-cc6d5c4d", "type": "gotcha", "text": "rc=0 backoff reset: _reap_and_restart() resets restart_count=0 and next_start_after=0.0 on clean exit. But restart='always' still re-queues with _backoff_delay(0) = ~1s, causing rapid restart. Solution: use restart='on-failure' for agents that should only restart on failure.", "created_at": "2026-02-22T09:59:26.720353+00:00"}
{"id": "b-a5ce353f", "type": "fact", "text": "default agent prompt (launcher.py _DEFAULT_PROMPT): 'call get_pending_messages() first; for each message read from_agent field, reply with send_message(to_agent=<from_agent>, body=<reply>); call get_pending_messages() again; stop when inbox empty'. TOML prompt= field overrides this per-agent.", "created_at": "2026-02-22T09:59:33.229136+00:00"}
{"id": "b-372dd63c", "type": "gotcha", "text": "gotcha: --resume <id> creates a NEW transcript file (new UUID) in ~/.claude/projects/<proj>/, not an extension of the original. The new file has the old session's id in its system entry. Stop hook archives the new fork. Launcher still sees the original session_id until session-start hook updates mux.db with the new session_id.", "created_at": "2026-02-22T10:00:40.340236+00:00"}
{"id": "b-50d55352", "type": "gotcha", "text": "gotcha: restart='always' causes 1-second restart loop even on rc=0 because _backoff_delay(0)=1s and restart_count resets to 0 on clean exit. Use restart='on-failure' + wake_on_message=true for message-driven agents.", "created_at": "2026-02-22T10:04:17.275436+00:00"}
{"id": "b-376b2aad", "type": "fact", "text": "session continuity: launcher uses --resume <prev_session_id> from mux.db agents table. No --fork-session needed. Session ID updated by session-start hook. Growing transcript = full memory across wakes.", "created_at": "2026-02-22T10:04:21.733593+00:00"}
{"id": "b-7a1dea85", "type": "fact", "text": "default prompt (updated): 'Call get_pending_messages(), for each message read from_agent field and reply with send_message(to_agent=from_agent_value, body=reply), call get_pending_messages() again, stop when empty.' Explicit from_agent reference prevents wrong recipient.", "created_at": "2026-02-22T10:04:25.550567+00:00"}
{"id": "b-54f5112e", "type": "gotcha", "text": "gotcha: after mux restart, agents table is empty \u2014 pending-count returns 0 for all agents until they register via session-start. Fix: launcher seeds kg_root into mux.db via _seed_kg_root_in_mux() during _sync_definitions for each new agent. Uses INSERT ... ON CONFLICT DO UPDATE SET kg_root=COALESCE(NULLIF...) to not clobber existing status/pid. [[kg-agent-mux]]", "created_at": "2026-02-23T05:29:23.223682+00:00"}
{"id": "b-38b83d67", "type": "fact", "text": "When running two kg instances, start each mux from its own root dir: cd /workspace and kg mux start, then cd /workspace/kg/kg and kg mux start. No --root flag exists \u2014 cwd determines which kg.toml is read.", "created_at": "2026-02-23T19:43:02.596146+00:00"}
{"id": "b-2870886e", "type": "gotcha", "text": "wake_on_message trigger requires a running launcher for that root. If launcher is missing, messages queue in mux but agent never wakes. Check: ps aux | grep launcher. Fix: cd to the right root and run kg launcher start.", "created_at": "2026-02-23T19:43:11.349369+00:00"}
