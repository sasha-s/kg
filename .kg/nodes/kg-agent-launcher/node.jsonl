{"v": 1, "slug": "kg-agent-launcher", "title": "kg-agent-launcher", "type": "concept", "created_at": "2026-02-22T06:25:24.750027+00:00"}
{"id": "b-ef11b376", "type": "decision", "text": "Launcher is a per-node process supervisor separate from mux. Reads .kg/agents/<name>.toml (one TOML per agent, git-tracked). Manages only agents with node==KG_NODE_NAME. Kills agents reallocated to other nodes. CLI: kg launcher start/stop/status/agent. [[kg-agent-mux]] [[agent-delegation]]", "created_at": "2026-02-22T06:25:24.750342+00:00"}
{"id": "b-53744b25", "type": "fact", "text": "Agent definition files at .kg/agents/<name>.toml: fields name, node, auto_start, restart (always/on-failure/never), wake_on_message, model, working_dir. One file per agent, git-tracked. Created by 'kg mux agent create <name> --node <node>'. Launcher reads all .kg/agents/*.toml on its node.", "created_at": "2026-02-22T06:25:29.264279+00:00"}
{"id": "b-a8a3cb18", "type": "decision", "text": "Pull-based node migration: change .kg/agents/alice.toml node= field + git commit + push. Launcher on old node sees node!=own \u2192 kills alice. Launcher on new node sees node==own \u2192 starts alice. No coordination between launchers needed.", "created_at": "2026-02-22T06:25:33.459508+00:00"}
{"id": "b-59f4b0dc", "type": "fact", "text": "Launcher._launch() runs: KG_AGENT_NAME=<name> claude --dangerously-skip-permissions in agent's working_dir (defaults to cfg.root). ANTHROPIC_MODEL env set if model field non-empty. stdout/stderr discarded (DEVNULL). [[kg-agent-mux]]", "created_at": "2026-02-22T06:25:38.091437+00:00"}
{"id": "b-c68f38d1", "type": "fact", "text": "Restart backoff: exponential base = min(2^restart_count, 60s) with \u00b120% jitter. restart='always' \u2192 always restart. 'on-failure' \u2192 restart only on non-zero exit. 'never' \u2192 leave idle. Backoff tracked per ManagedAgent.next_start_after (monotonic).", "created_at": "2026-02-22T06:25:42.451049+00:00"}
{"id": "b-dd1e1e26", "type": "fact", "text": "wake_on_message: idle agents with pending mux messages are auto-started (polls /agent/<name>/pending on mux). Only fires if proc is None + not in backoff. Default true in TOML.", "created_at": "2026-02-22T06:25:46.381018+00:00"}
{"id": "b-f4bf63a4", "type": "fact", "text": "Launcher runs git pull --rebase --autostash in cfg.root on every poll cycle to pick up new agent TOML allocations. Failure is silently swallowed (offline/no remote is fine).", "created_at": "2026-02-22T06:25:50.826089+00:00"}
{"id": "b-34ab8886", "type": "fact", "text": "PID files: launcher PID at ~/.local/share/kg/.launcher.pid (respects XDG_DATA_HOME). start_background() checks PID + os.kill(pid, 0) to detect stale. Log at ~/.local/share/kg/launcher.log.", "created_at": "2026-02-22T06:25:55.101846+00:00"}
{"id": "b-7e66566e", "type": "fact", "text": "AgentDef.status field (running | paused | draining): 'paused' \u2192 launcher terminates agent immediately and does NOT restart; 'draining' \u2192 launcher lets agent finish current session, does NOT restart on exit; 'running' (default) \u2192 normal restart policy applies. Only written to TOML when non-default.", "created_at": "2026-02-22T06:30:50.991799+00:00"}
{"id": "b-908e14c1", "type": "fact", "text": "kg launcher agent subcommands: 'pause <name>' \u2192 writes status=paused to TOML; 'resume <name>' \u2192 writes status=running; 'drain <name>' \u2192 writes status=draining; 'migrate <name> --to <node>' \u2192 atomically changes node + status=running in TOML (old node kills, new node starts). --drain flag on migrate sets status=draining first and prints follow-up command for when agent stops.", "created_at": "2026-02-22T06:30:55.835485+00:00"}
{"id": "b-551e6060", "type": "fact", "text": "update_agent_def(cfg, name, **kwargs) helper reads .kg/agents/<name>.toml into AgentDef, patches any fields with setattr, rewrites via toml_str(). Used by all launcher agent subcommands. Raises FileNotFoundError if TOML missing.", "created_at": "2026-02-22T06:30:57.848500+00:00"}
{"id": "b-a9dc4534", "type": "fact", "text": "Launcher._sync_definitions() status handling: if status==paused and proc running \u2192 _terminate immediately; if status==paused or draining \u2192 skip auto_start; _reap_and_restart() skips restart if status in (paused, draining); _wake_on_message() skips if status != running; _launch() short-circuits if status != running.", "created_at": "2026-02-22T06:31:02.377610+00:00"}
{"id": "b-81955421", "type": "note", "text": "Two-layer file watching for launcher TOML changes (IMPLEMENTED): (1) inotify_simple watches .kg/agents/ dir \u2014 on any .toml change immediately calls _sync_definitions()+_reap_and_restart()+_wake_on_message(); (2) git pull at poll_interval (default 30s) for remote TOML changes. Falls back to pure polling (_run_poll) if inotify_simple unavailable. KG_LAUNCHER_POLL env var overrides poll interval (CLI --poll takes precedence if > 0).", "created_at": "2026-02-22T06:31:04.946977+00:00", "updated_at": "2026-02-22T06:48:00.994503+00:00"}
