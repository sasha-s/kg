{"v": 1, "slug": "kg-agent-mux", "title": "kg Agent Mux", "type": "concept", "created_at": "2026-02-22T04:30:50.924411+00:00"}
{"id": "b-a567c962", "type": "fact", "text": "kg mux commands: start, stop, status, send <to> <msg>, messages, agent create/list/delete. Web UI at /agents route on web_port (default 8347). [[kg-architecture]]", "created_at": "2026-02-22T04:30:54.857775+00:00", "updated_at": "2026-02-22T05:46:46.952309+00:00"}
{"id": "b-db154300", "type": "fact", "text": "kg.toml [agents] section: enabled (bool), name (optional fallback \u2014 prefer KG_AGENT_NAME env var), mux_url (default http://127.0.0.1:7346), mux_port (default 7346). Only enabled=true required; name resolved at runtime from env.", "created_at": "2026-02-22T04:30:58.777840+00:00", "updated_at": "2026-02-22T05:46:10.226650+00:00"}
{"id": "b-282102bd", "type": "fact", "text": "Agent mux quick start: (1) set enabled=true in [agents] of kg.toml, (2) kg mux start -d, (3) kg agent create alice, (4) kg run alice (or kg run alice --unsafe for --dangerously-skip-permissions), (5) kg mux send alice 'hello'. 'kg agent' is a top-level alias for 'kg mux agent'. [[kg-architecture]] [[kg-agent-launcher]]", "created_at": "2026-02-22T04:31:02.362202+00:00", "updated_at": "2026-02-22T07:31:58.243904+00:00"}
{"id": "b-bd0f2842", "type": "fact", "text": "Agent hooks: session-start (register + inject instructions + pending msgs), user-prompt-submit (poll new msgs), post-tool-use (heartbeat + urgent), stop (archive + ack or block), session-end (mark idle on crash). Hooks pass kg_root to mux at session-start and heartbeat. [[kg-stop-hook]]", "created_at": "2026-02-22T04:31:05.716242+00:00", "updated_at": "2026-02-22T06:08:05.673047+00:00"}
{"id": "b-26446901", "type": "gotcha", "text": "Mux is currently project-scoped: mux_db_path=.kg/index/mux.db and mux_pid_path=.kg/index/.mux.pid are relative to the kg project root. Two projects both running 'kg mux start' conflict on port 7346, and agents in different projects can't message each other.", "created_at": "2026-02-22T04:49:30.700895+00:00"}
{"id": "b-1e78fbd7", "type": "decision", "text": "Mux DB and PID are user-level: ~/.local/share/kg/mux.db and ~/.local/share/kg/.mux.pid (respects XDG_DATA_HOME). One mux serves all kg projects on the machine. start_background passes --db <path> --port <port> to subprocess.", "created_at": "2026-02-22T04:49:34.376273+00:00", "updated_at": "2026-02-22T05:46:23.753814+00:00"}
{"id": "b-348a9590", "type": "gotcha", "text": "Multiple agents on the same project all share the same name from kg.toml \u2014 they collide on the mux. Fix: KG_AGENT_NAME env var override (check os.environ before kg.toml). Allows e.g. KG_AGENT_NAME=worker-1 claude for each window.", "created_at": "2026-02-22T04:49:38.745547+00:00"}
{"id": "b-82a9dbb2", "type": "fact", "text": "Agent registration is automatic \u2014 no pre-registration step. First SessionStart hook auto-upserts the agent record into the mux agents table via POST /agent/{name}/session-start.", "created_at": "2026-02-22T04:49:41.790172+00:00"}
{"id": "b-5a934e6b", "type": "decision", "text": "Session archiving (transcript copy to .kg/sessions/<agent>/<session_id>.jsonl) is done by the Stop hook (_archive_session_local), not the mux server. Mux server is message routing only \u2014 no sessions_dir needed.", "created_at": "2026-02-22T04:49:47.291680+00:00", "updated_at": "2026-02-22T05:46:28.842981+00:00"}
{"id": "b-3a5eed87", "type": "fact", "text": "addressing scheme: local:alice = agent 'alice' on the local mux; sprite-name:alice = agent 'alice' on a remote mux (forwarded via sprite's HTTP proxy). Enables cross-sprite agent messaging.", "created_at": "2026-02-22T05:23:51.179787+00:00"}
{"id": "b-8cd8a2f7", "type": "decision", "text": "KG_AGENT_NAME env var overrides kg.toml name \u2014 allows multiple agents in same project to have distinct identities. Usage: KG_AGENT_NAME=worker-1 claude. Check os.environ before kg.toml at hook registration.", "created_at": "2026-02-22T05:23:55.974597+00:00", "updated_at": "2026-02-22T05:25:37.321549+00:00"}
{"id": "b-c8238510", "type": "decision", "text": "kg mux agent subcommands (implemented): 'create <name>' \u2014 upserts mux DB entry + creates agent-<name>-mission + agent-<name> KG nodes; 'list' \u2014 shows agents with status + pending count; 'delete <name>' \u2014 removes from mux (KG nodes kept). [[agent-delegation]]", "created_at": "2026-02-22T05:29:45.630221+00:00", "updated_at": "2026-02-22T09:25:18.373781+00:00"}
{"id": "b-4a21b993", "type": "decision", "text": "'kg run <name>' command implemented \u2014 sets KG_AGENT_NAME env + reads .kg/agents/<name>.toml for model/working_dir; launches claude with optional --unsafe (--dangerously-skip-permissions). Usage: kg run alice, kg run alice --unsafe. [[sprites-dev]]", "created_at": "2026-02-22T05:29:47.887341+00:00", "updated_at": "2026-02-22T06:47:48.431797+00:00"}
{"id": "b-90968937", "type": "decision", "text": "Agent node pair: agent-<name>-mission (verbatim injection at SessionStart \u2014 mission/rules, like per-agent CLAUDE.md) + agent-<name> (working memory, accumulated across sessions, accessed via MCP tools). hooks.py falls back to legacy agent-<name>-instructions slug if -mission not found. Stop hook prompts extraction claude to write learnings to agent-<name>.", "created_at": "2026-02-22T05:40:25.057951+00:00", "updated_at": "2026-02-22T09:25:10.296478+00:00"}
{"id": "b-2a3b7a74", "type": "fact", "text": "'kg mux agent create <name>' should: (1) upsert agent in mux DB, (2) create agent-<name>-instructions node with starter bullet, (3) create agent-<name> node for working memory. [[agent-delegation]]", "created_at": "2026-02-22T05:40:28.729539+00:00"}
{"id": "b-b273c23e", "type": "decision", "text": "SessionStart hook injects: (1) agent-<name>-mission bullets verbatim (falls back to -instructions for legacy nodes), (2) pending mux messages. agent-<name> working memory is NOT injected \u2014 accessed on demand via kg MCP tools.", "created_at": "2026-02-22T05:40:32.424292+00:00", "updated_at": "2026-02-22T09:25:12.116982+00:00"}
{"id": "b-26446901", "deleted": true}
{"id": "b-348a9590", "deleted": true}
{"id": "b-2a3b7a74", "deleted": true}
{"id": "b-f8f38ab1", "type": "gotcha", "text": "(gotcha) Current messages.status field + single acked_through on agents is broken for multi-sender: can't ack bob's messages independently from orchestrator's. Also single-inbox JSONL would have multiple writers \u2014 git conflict on sync.", "created_at": "2026-02-22T05:49:09.789849+00:00"}
{"id": "b-6aaa216a", "type": "decision", "text": "Per-sender inbox: ack state is per (agent, from_agent) pair \u2014 agent acks bob's messages independently from orchestrator's. File-based: .kg/messages/<agent>/acks/<sender>.json replaces acked_through column on agents table. SQLite acks table is cache only.", "created_at": "2026-02-22T05:49:11.542069+00:00", "updated_at": "2026-02-22T05:53:59.879221+00:00"}
{"id": "b-9ccb81a8", "type": "decision", "text": "JSONL inbox layout (implemented): .kg/messages/<agent>/inbox/from/<sender>/messages-00001.jsonl (normal, segment_lines=500) + urgent-00001.jsonl (urgent separate). Acks: .kg/messages/<agent>/acks/<sender>.json \u2192 {normal_delivered, normal_acked, urgent_delivered, urgent_session_delivered, urgent_acked}. One writer per path = zero git conflicts. SQLite messages.db = derived index (with acked column), never committed.", "created_at": "2026-02-22T05:49:15.758304+00:00", "updated_at": "2026-02-22T08:51:34.233192+00:00"}
{"id": "b-72731acf", "type": "task", "text": "(task) planned: add send_message MCP tool \u2014 sender auto-populated from KG_AGENT_NAME env (inherited by MCP server subprocess), recipient is explicit arg. Closes agent communication loop without requiring Bash tool access.", "status": "pending", "created_at": "2026-02-22T05:49:17.131200+00:00"}
{"id": "b-c3435d7b", "type": "decision", "text": "Inbox cap (implemented): max 50 unacked normal messages per sender ([agents] max_inbox=50, 0=unlimited). Mux returns HTTP 429 if over cap and urgency != urgent. Urgent messages always accepted \u2014 bypass cap. Cap checked via messages.db COUNT query before writing JSONL.", "created_at": "2026-02-22T05:54:04.085727+00:00", "updated_at": "2026-02-22T06:07:42.307680+00:00"}
{"id": "b-bfc3aaef", "type": "fact", "text": "Sender identity: KG_AGENT_NAME is auto-used as sender by MCP send_message tool (MCP server subprocess inherits env from Claude Code session). Recipient is always explicit. Agents reply using from_agent field visible in injected message context.", "created_at": "2026-02-22T05:54:08.362307+00:00"}
{"id": "b-bcec911a", "type": "decision", "text": "Two-pointer ack model per sender: delivered_through (set when injected, reset on crash for re-delivery) + acked_through (set at Stop, permanent, safe for compaction). Crash = delivered_through > acked_through \u2192 re-read from acked_through on next SessionStart.", "created_at": "2026-02-22T05:57:55.616266+00:00"}
{"id": "b-7dcffb58", "type": "decision", "text": "mux agents table needs kg_root column \u2014 when agent registers at SessionStart it sends its project root. Mux uses kg_root to write message JSONL files to the correct project's .kg/messages/. Project-local messages.db (index) lives at .kg/index/messages.db.", "created_at": "2026-02-22T05:57:59.864699+00:00"}
{"id": "b-7e1691e6", "type": "decision", "text": "git_sync config fields added to AgentsConfig (git_repo, git_branch). Actual git operations (commit after ack, pull-rebase retry on conflict) not yet implemented. git_branch mandatory when git_sync=true \u2014 enforced at runtime. Separate repo recommended.", "created_at": "2026-02-22T05:58:05.125416+00:00", "updated_at": "2026-02-22T06:07:56.271181+00:00"}
{"id": "b-960de69a", "type": "task", "text": "planned: kg mux agent compact <name> \u2014 deletes fully-acked segment files (all message IDs <= acked_through). Safe because acked_through only advances at Stop. Identifies compactable segments by comparing last message ID in segment to acked_through.", "status": "pending", "created_at": "2026-02-22T05:58:09.035444+00:00"}
{"id": "b-f8f38ab1", "deleted": true}
{"id": "b-42eba444", "type": "fact", "text": "mux_messages CLI command queries .kg/index/messages.db (project-local), not mux.db. Supports --agent, --from, --urgency, --limit filters. mux.db only holds agents table now \u2014 no messages.", "created_at": "2026-02-22T06:08:11.580843+00:00"}
{"id": "b-d2da762e", "type": "gotcha", "text": "gotcha: agent_list CLI still queries messages table (which no longer exists in mux.db) for pending counts \u2014 will fail at runtime. Needs fix: query messages.db per-agent or remove pending count from list.", "created_at": "2026-02-22T06:08:16.221651+00:00"}
{"id": "b-3aabd697", "type": "decision", "text": "planned: Launcher \u2014 separate process from mux, manages agent runtimes on a node. Reads .kg/agents.toml (git-tracked declarative allocation). Responsible for: auto_start agents, wake_on_message (poll mux, start idle agents with pending msgs), restart policy (always/on-failure/never), PID tracking, graceful shutdown. [[agent-delegation]]", "created_at": "2026-02-22T06:12:27.490097+00:00"}
{"id": "b-c65fd6e6", "type": "decision", "text": "planned: .kg/agents.toml declares agent-to-node allocation (git-tracked). Fields per [[agent]]: name, node, auto_start, restart (always/on-failure/never), wake_on_message. Launcher reads this on its node and manages matching agents. Node identity from [agents] node= in kg.toml or KG_NODE_NAME env var.", "created_at": "2026-02-22T06:12:29.655496+00:00"}
{"id": "b-3bb91a2c", "type": "gotcha", "text": "gotcha: agent_list CLI (kg mux agent list) still queries messages table in mux.db for pending counts \u2014 table no longer exists after JSONL refactor. Fix: query .kg/index/messages.db per agent, or drop pending count from list output.", "created_at": "2026-02-22T06:12:34.046737+00:00"}
{"id": "b-3bb91a2c", "deleted": true}
{"id": "b-d1684a7e", "type": "decision", "text": "planned: Launcher \u2014 per-node process supervisor separate from mux. Reads .kg/agents/<name>.toml (one file per agent, git-tracked). Manages only agents with node==its own node name. Kills agents whose toml says node!=own node (reallocation). CLI: kg launcher start/stop/status + kg launcher agent start/stop/restart. [[agent-delegation]]", "created_at": "2026-02-22T06:17:02.924370+00:00"}
{"id": "b-03ee5a39", "type": "decision", "text": "planned: agent definition files at .kg/agents/<name>.toml \u2014 one per agent, git-tracked. Fields: name, node, auto_start, restart (always/on-failure/never), wake_on_message, model, working_dir. Created by 'kg mux agent create <name> --node <node>'. Launcher reads all .kg/agents/*.toml on its node.", "created_at": "2026-02-22T06:17:07.599214+00:00"}
{"id": "b-3101dbc6", "type": "decision", "text": "planned: pull-based node migration \u2014 change .kg/agents/alice.toml node= field + git commit + push. Launcher on old node sees node!=own \u2192 kills alice. Launcher on new node sees node==own \u2192 starts alice. No coordination between launchers needed.", "created_at": "2026-02-22T06:17:12.868274+00:00"}
{"id": "b-3aabd697", "deleted": true}
{"id": "b-c65fd6e6", "deleted": true}
{"id": "b-d1684a7e", "deleted": true}
{"id": "b-03ee5a39", "deleted": true}
{"id": "b-3101dbc6", "deleted": true}
{"id": "b-1a7718b1", "type": "gotcha", "text": "messages.db now has 'acked INTEGER DEFAULT 0' column (added this session). Pending count query uses WHERE acked=0. Stop hook calls _ack_messages_in_db() after writing ack files. Migration: ALTER TABLE messages ADD COLUMN acked INTEGER NOT NULL DEFAULT 0 (try/except in _init_messages_db). [[kg-agent-mux]]", "created_at": "2026-02-22T06:31:09.992165+00:00", "updated_at": "2026-02-22T08:18:06.719603+00:00"}
{"id": "b-3f648b69", "type": "note", "text": "sessions_sync is local-only by default (.kg/sessions/<agent>/<session_id>.jsonl). A sessions_sync=true AgentsConfig option could trigger git add+commit in stop hook after _archive_session_local(), but not yet implemented \u2014 keeping sessions out of git avoids large binary blobs and transcript noise.", "created_at": "2026-02-22T06:31:14.977644+00:00"}
{"id": "b-d2da762e", "deleted": true}
{"id": "b-2e70f582", "type": "fact", "text": "sessions_sync=true in [agents]: stop hook git-adds .kg/sessions/<agent>/<session_id>.jsonl and creates a git commit ('session: <agent> <id>') after _archive_session_local. Opt-in, default false. Lets you track session history in git. [[kg-stop-hook]]", "created_at": "2026-02-22T06:40:51.501712+00:00"}
{"id": "b-72731acf", "deleted": true}
{"id": "b-3f648b69", "deleted": true}
{"id": "b-2dd90a3a", "type": "fact", "text": "Heartbeat timeout: [agents] heartbeat_timeout=10 (minutes, 0=disabled). Mux runs a background reaper thread (every 60s) that sets status='idle' WHERE status='running' AND last_seen < now-timeout. Wires through both start_server() and __main__ subprocess via --heartbeat-timeout arg.", "created_at": "2026-02-22T06:48:07.166965+00:00"}
{"id": "b-903e91ec", "type": "fact", "text": "send_message MCP tool (implemented in mcp.py): @mcp.tool() send_message(to_agent, body, urgency='normal') \u2192 str. Auto-uses cfg.agent_name (KG_AGENT_NAME env) as sender. POSTs to {mux_url}/agent/{to_agent}/messages. Returns message id or error string. Agents communicate without Bash access. [[kg-architecture]]", "created_at": "2026-02-22T06:48:13.071100+00:00"}
{"id": "b-8515f327", "type": "gotcha", "text": "(gotcha) kg init check bug: was 'cfg.agents.enabled and cfg.agents.name' \u2014 prevented mux auto-start when name came from KG_AGENT_NAME env at session time. Fixed to 'cfg.agents.enabled' only. Similarly kg mux send used cfg.agents.name (static) instead of cfg.agent_name (env-aware) \u2014 fixed.", "created_at": "2026-02-22T06:48:20.433978+00:00"}
{"id": "b-1e1e6cb6", "type": "fact", "text": "sessions_sync=true in [agents]: stop hook git-adds .kg/sessions/<agent>/<session_id>.jsonl and runs git commit ('session: <agent> <id[:16]>') after _archive_session_local. Opt-in (default false). heartbeat_timeout=10 (int, minutes). Both added to AgentsConfig dataclass + load_config() parsing. [[kg-stop-hook]]", "created_at": "2026-02-22T06:48:45.956146+00:00"}
{"id": "b-d8246c77", "type": "fact", "text": "Optional kg.toml [agents] settings: sessions_sync=true (git-commit session transcripts after each session), heartbeat_timeout=10 (minutes before idle mark; 0=disabled), max_inbox=50 (unacked msg cap per sender). All default to off/conservative. [[kg-stop-hook]]", "created_at": "2026-02-22T06:54:11.212679+00:00"}
{"id": "b-b53ed924", "type": "fact", "text": "kg agent is a top-level alias for kg mux agent \u2014 provides create/list/delete subcommands directly as 'kg agent create <name>' without the mux prefix. Added for discoverability.", "created_at": "2026-02-22T07:02:12.917768+00:00"}
{"id": "b-8c46a724", "type": "gotcha", "text": "web UI chat requires mux running \u2014 /agent/<name>/message POSTs to mux_url; if mux is down the request fails (now shows error flash, previously silent). Agents also need an active 'kg run <name>' session to respond; messages queue in mux until session connects. [[kg-web]]", "created_at": "2026-02-22T07:09:36.482326+00:00", "updated_at": "2026-02-22T07:10:25.300564+00:00"}
{"id": "b-2e70f582", "deleted": true}
{"id": "b-1e1e6cb6", "deleted": true}
{"id": "b-86928373", "type": "fact", "text": "'kg agent' is a top-level alias for 'kg mux agent' \u2014 provides kg agent create/list/delete without typing 'mux' [[kg-agent-launcher]]", "created_at": "2026-02-22T07:13:25.785396+00:00"}
{"id": "b-27e6e308", "type": "fact", "text": "GET /agent/<name>/pending-count: non-destructive count of undelivered messages (both normal+urgent). Used by launcher for wake_on_message check. Returns {count: N}. Does not advance ack pointers. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:16:27.016981+00:00"}
{"id": "b-0d3cb9e2", "type": "gotcha", "text": "Gotcha: GET /agent/<name>/pending marks normal messages as normal_delivered \u2014 it has a side effect and is NOT safe to use as a wake check. Use /pending-count instead for non-destructive polling. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:16:30.966686+00:00"}
{"id": "b-0f64fd3e", "type": "fact", "text": "kg agent is a top-level CLI alias for 'kg mux agent' \u2014 added to cli.py via cli.add_command(agent_cli, name='agent'). Supports: kg agent create <name>, kg agent list, kg agent delete <name>.", "created_at": "2026-02-22T07:16:47.480713+00:00"}
{"id": "b-0f64fd3e", "deleted": true}
{"id": "b-86928373", "deleted": true}
{"id": "b-b53ed924", "deleted": true}
{"id": "b-e3662953", "type": "gotcha", "text": "GET /pending is DESTRUCTIVE \u2014 marks normal_delivered ack. Never use it for wake-checks (was a bug). Use GET /agent/<name>/pending-count instead: counts undelivered normal+urgent without side effects. Launcher uses /pending-count to avoid consuming messages before session starts. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:20:17.197878+00:00"}
{"id": "b-769fe09f", "type": "fact", "text": "Web UI chat always sends as urgent (hidden field, no checkbox). Urgent messages are injected at next PostToolUse heartbeat into running sessions. Non-urgent queues until next session start. Launcher wake-check uses /pending-count which includes both urgencies.", "created_at": "2026-02-22T07:20:17.747262+00:00"}
{"id": "b-bd8ee387", "type": "fact", "text": "'kg agent' is a top-level CLI alias for 'kg mux agent' \u2014 quicker access to create/list/delete. Registered via cli.add_command(agent_cli, name='agent').", "created_at": "2026-02-22T07:20:18.305876+00:00"}
{"id": "b-f560ab81", "type": "gotcha", "text": "kg mux start / kg launcher start: default is background (daemonized). Use -f / --foreground for foreground blocking mode. There is NO -d flag.", "created_at": "2026-02-22T07:20:18.865994+00:00"}
{"id": "b-817e99b0", "type": "fact", "text": "mux start/launcher start: default mode is background (no flag needed). Use -f/--foreground for blocking. -d/--daemon flag also accepted (no-op alias for clarity). 'kg mux start -d' and 'kg launcher start -d' work as expected. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:24:37.997551+00:00"}
{"id": "b-cd0de056", "type": "fact", "text": "/agent/<name> chat form: always sends urgent (hidden input urgent=1, no checkbox). Urgent messages injected into running session via PostToolUse heartbeat hook. /agents list page has 'chat \u2192' button on each card linking to /agent/<name>. [[kg-web]]", "created_at": "2026-02-22T07:24:38.551118+00:00"}
{"id": "b-53a18fe3", "type": "gotcha", "text": "(gotcha) GET /pending was destructive AND only returned normal messages \u2014 caused launcher wake check to accidentally mark messages as delivered before session started, AND missed urgent messages entirely. Fixed: added GET /agent/<name>/pending-count (non-destructive, counts both normal+urgent undelivered). Launcher wake_on_message now uses /pending-count. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:24:43.965957+00:00"}
{"id": "b-4b34cc74", "type": "fact", "text": "Web agent chat model: (1) type in /agent/<name> \u2192 sends urgent to mux; (2) if agent idle, launcher sees pending-count>0 \u2192 wakes agent (within poll interval, default 30s); (3) heartbeat hook injects urgent msg as additionalContext between tool calls; (4) agent replies via send_message MCP tool \u2192 stored in messages.db \u2192 shown in thread on next 8s auto-refresh. NOT an interactive terminal session.", "created_at": "2026-02-22T07:24:53.672901+00:00"}
{"id": "b-74332a63", "type": "fact", "text": "sessions_sync=true in AgentsConfig: after _archive_session_local in Stop hook, if enabled commits the session transcript to git (git add + git commit). Configured in [agents] sessions_sync=true in kg.toml.", "created_at": "2026-02-22T07:29:23.355564+00:00"}
{"id": "b-6662dc5e", "type": "fact", "text": "POST /agent/<name>/ctrl: accepts {action: pause|resume|drain|migrate, node: <target>} body \u2014 calls update_agent_def() to patch .kg/agents/<name>.toml status or node field. Enables web UI control of agent lifecycle. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:29:26.801004+00:00"}
{"id": "b-70176b47", "type": "fact", "text": "Web /agents page: _mux_agents() 3-way merge of mux.db (status/last_seen) + .kg/agents/*.toml (AgentDef: node/restart/auto_start/toml_status) + messages.db (pending count). Each agent card links to /agent/<name> detail page with message history and ctrl buttons.", "created_at": "2026-02-22T07:29:31.013733+00:00"}
{"id": "b-baba1a5c", "type": "fact", "text": "Web /agent/<name> detail page: shows agent instructions, message history (from messages.db), idle banner with 'kg run <name>' hint when not running, ctrl buttons (pause/resume/drain), urgent message send form, 8s auto-refresh. Always uses urgency=urgent for web-sent messages.", "created_at": "2026-02-22T07:29:35.303575+00:00"}
{"id": "b-d0414750", "type": "fact", "text": "GET /agent/<name>/pending-count: non-destructive count of undelivered normal+urgent messages (checks acks vs messages.db). Used by launcher wake_on_message check \u2014 does NOT advance normal_delivered pointer unlike /pending. Returns {count: N}. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:29:39.939030+00:00"}
{"id": "b-a77c6bb3", "type": "fact", "text": "heartbeat_timeout=10 in AgentsConfig: minutes before mux marks an agent idle if no heartbeat received (0=disabled). Separate from stop hook ack. Prevents stuck 'running' status on agents that crashed without session_end.", "created_at": "2026-02-22T07:29:44.670688+00:00"}
{"id": "b-97b0dce2", "type": "fact", "text": "kg agent top-level alias: 'kg agent' is a registered alias for 'kg mux agent' in main cli.py \u2014 both 'kg agent create alice' and 'kg mux agent create alice' work. Also: no_args_is_help=True on all required-argument commands.", "created_at": "2026-02-22T07:29:48.744753+00:00"}
{"id": "b-8b02b6a7", "type": "task", "text": "pending: sprite addressing (local:alice vs sprite-name:alice mux-to-mux routing in mux send); kg mux agent compact <name> (delete fully-acked JSONL segment files); LiteLLM OAuth token persistence for Claude max subscription on headless sprites; KG node existence check in agent_list", "status": "pending", "created_at": "2026-02-22T07:30:06.074204+00:00"}
{"id": "b-447baa80", "type": "gotcha", "text": "gotcha: 'kg agent create' used to INSERT without kg_root \u2192 mux returned 404 on first message send. Fixed: now calls _upsert_agent(conn, name, 'idle', None, str(cfg.root)) so messages work immediately without needing a prior session.", "created_at": "2026-02-22T07:31:08.597238+00:00"}
{"id": "b-0f5d4920", "type": "fact", "text": "GET /agent/<name>/pending-count endpoint: non-destructive count of ALL pending messages (normal unacked + urgent undelivered) without side effects. Used by launcher wake_on_message check. Contrast with /pending which marks normal messages as normal_delivered (destructive).", "created_at": "2026-02-22T07:31:12.693432+00:00"}
{"id": "b-cbf151f2", "type": "gotcha", "text": "gotcha: uv run kg vs kg (uv tool) use different Python venvs. If both start the mux, only the first on port 7346 wins \u2014 the other fails silently and the running process has old code. Always use 'kg' (uv tool) consistently. Kill stale mux via: ps aux | grep kg.agents.mux, then kill <pid> + kg mux start.", "created_at": "2026-02-22T07:31:17.958021+00:00"}
{"id": "b-45fd33f8", "type": "fact", "text": "kg mux start and kg launcher start: -d/--daemon flag added (no-op, background is default). -f/--foreground for blocking mode. Convention: 'kg mux start -d' and 'kg launcher start -d' both work as expected now.", "created_at": "2026-02-22T07:31:37.283072+00:00"}
{"id": "b-05bd88f2", "type": "fact", "text": "'kg agent' is a top-level alias for 'kg mux agent' \u2014 create/list/delete subcommands work at both 'kg agent create' and 'kg mux agent create'. [[kg-architecture]]", "created_at": "2026-02-22T07:31:40.937868+00:00"}
{"id": "b-27e6e308", "deleted": true}
{"id": "b-0d3cb9e2", "deleted": true}
{"id": "b-e3662953", "deleted": true}
{"id": "b-0f5d4920", "deleted": true}
{"id": "b-53a18fe3", "deleted": true}
{"id": "b-f560ab81", "deleted": true}
{"id": "b-45fd33f8", "deleted": true}
{"id": "b-bd8ee387", "deleted": true}
{"id": "b-05bd88f2", "deleted": true}
{"id": "b-769fe09f", "deleted": true}
{"id": "b-baba1a5c", "deleted": true}
{"id": "b-70176b47", "deleted": true}
{"id": "b-6662dc5e", "deleted": true}
{"id": "b-97b0dce2", "deleted": true}
{"id": "b-447baa80", "deleted": true}
{"id": "b-8c46a724", "deleted": true}
{"id": "b-adba9fa5", "type": "fact", "text": "GET /agent/<name>/pending-count \u2014 non-destructive count of undelivered normal+urgent messages; used by launcher wake check", "created_at": "2026-02-22T07:40:54.829724+00:00"}
{"id": "b-13ff1429", "type": "gotcha", "text": "agent kg_root must be set in mux.db for messages to work; kg agent create now calls _upsert_agent with cfg.root so messages work before first session", "created_at": "2026-02-22T07:40:59.524768+00:00"}
{"id": "b-70a6df3e", "type": "gotcha", "text": "two mux processes can conflict if started via different Python envs (uv tool vs uv run); always use same kg binary to manage mux", "created_at": "2026-02-22T07:41:05.001637+00:00"}
{"id": "b-fff31d07", "type": "fact", "text": "kg agent create registers in mux.db with kg_root=cfg.root so messages work before first session. Without kg_root set, /agent/<name>/messages returns 404. Also writes .kg/agents/<name>.toml and creates KG nodes agent-<name>-instructions + agent-<name>.", "created_at": "2026-02-22T07:49:18.365155+00:00"}
{"id": "b-93af680d", "type": "fact", "text": "GET /agent/<name>/pending-count \u2014 non-destructive count of undelivered messages (normal + urgent). Used by launcher wake_on_message check. Does NOT advance ack pointers. Returns {count: N}. [[kg-agent-launcher]]", "created_at": "2026-02-22T07:49:23.042846+00:00"}
{"id": "b-29680bbf", "type": "fact", "text": "Web chat always sends urgent (hidden field urgent=1, no checkbox). Urgent messages are injected via PostToolUse heartbeat hook as additionalContext. Normal messages queue for next session start. Web UI auto-refreshes every 8s. Enter to send (Shift+Enter for newline).", "created_at": "2026-02-22T07:49:29.295733+00:00"}
{"id": "b-ed5fe753", "type": "gotcha", "text": "Agent hooks must be installed project-local (.claude/settings.json at cfg.root), NOT global (~/.claude/settings.json). ensure_agent_hooks_installed() defaults to cfg.root/.claude/settings.json. Installing globally causes hooks to fire in all sessions including non-agent ones.", "created_at": "2026-02-22T07:49:34.225991+00:00"}
{"id": "b-3cefe852", "type": "gotcha", "text": "(gotcha) send_message MCP tool fails with 'agents not enabled' when the MCP server was started from a parent workspace .mcp.json that points to a root without [agents] enabled=true. The tool uses cfg loaded from --root arg, not cwd. Fix: place .mcp.json in the agent's working dir (kg root) pointing to that root.", "created_at": "2026-02-22T07:59:42.528422+00:00"}
{"id": "b-25e2e69d", "type": "gotcha", "text": "(gotcha) 'web' sender identity (web UI \u2192 POST /agent/<name>/message with from='web') is NOT a registered mux agent. To reply to web, first call POST /agent/web/session-start with kg_root, which registers it; then send messages via mux as normal. Without registration, mux returns 404 'agent not registered'.", "created_at": "2026-02-22T07:59:48.186839+00:00"}
{"id": "b-7566c1e7", "type": "fact", "text": "Urgent messages from web UI are delivered one per heartbeat (PostToolUse async hook calls POST /agent/<name>/heartbeat). Normal pending messages injected on each UserPromptSubmit (GET /agent/<name>/pending). SessionStart delivers ALL unacked (crash recovery). Stop hook commits acks via POST /agent/<name>/stop.", "created_at": "2026-02-22T07:59:58.519783+00:00"}
{"id": "b-b088b501", "type": "success", "text": "Fix applied: renamed /workspace/kg/kg/.mcp.json1221 \u2192 .mcp.json (content: kg serve --root /workspace/kg/kg using .venv/bin/kg). Future agent sessions launched from that dir will use this config, enabling send_message MCP tool. [[kg-agent-launcher]]", "created_at": "2026-02-22T08:00:03.296507+00:00"}
{"id": "b-aa4e5cf1", "type": "gotcha", "text": "gotcha: _handle_send uses RECIPIENT's kg_root \u2014 replies from agent 'test' to unregistered 'web' return 404. Fix: use sender_root OR recip_root so agent replies are stored in sender's project messages.db, visible in web UI at /agent/<name> (WHERE to_agent=name OR from_agent=name)", "created_at": "2026-02-22T08:01:19.865568+00:00"}
{"id": "b-6de7bfce", "type": "gotcha", "text": "gotcha: messages arriving AFTER session start are only delivered via PostToolUse heartbeat, not SessionStart. If agent is launched before any messages exist and messages arrive later, SessionStart hook returns empty; agent needs to be running (using tools) to receive them via heartbeat", "created_at": "2026-02-22T08:01:24.065906+00:00"}
{"id": "b-4afbaffb", "type": "fact", "text": "Auto-register sender on receive: _handle_send() upserts from_agent into mux.db using to_agent kg_root when from_agent is not registered. Enables agent-to-sender replies without manual kg agent create. [[kg-architecture]]", "created_at": "2026-02-22T08:18:18.058692+00:00"}
{"id": "b-391fb6bb", "type": "fact", "text": "Pseudo-agent filtering in web UI: _list_agents() only shows agents with a .kg/agents/<name>.toml file (_has_toml flag). Auto-registered senders like 'web' are hidden from the agents list without a TOML file.", "created_at": "2026-02-22T08:18:22.336595+00:00"}
{"id": "b-c4e625df", "type": "fact", "text": "session_id column added to agents table in mux.db. Populated by _handle_session_start() from hook_data. _upsert_agent() accepts optional session_id, only overwrites if non-empty. kg agent list displays first 16 chars.", "created_at": "2026-02-22T08:18:26.300211+00:00"}
{"id": "b-981cf517", "type": "gotcha", "text": "Gotcha: agent with restart=always + wake_on_message=true will loop continuously if it exits with rc=0 and has no pending messages \u2014 launcher sees idle, checks pending (0), does not wake, but restart=always triggers on normal exit. Use restart=on-failure for agents that should only run when there is work.", "created_at": "2026-02-22T08:18:31.649091+00:00"}
{"id": "b-c20516de", "type": "success", "text": "End-to-end verified: --print mode + SessionStart hook injection + send_message MCP tool works. Agent ran rc=0, processed 4 messages, sent 2 replies via send_message. Key requirement: .mcp.json must exist at project root with correct kg binary path and --root pointing to project. [[kg-architecture]]", "created_at": "2026-02-22T08:18:36.424043+00:00"}
{"id": "b-43f94875", "type": "gotcha", "text": "Gotcha: if agent cannot send to recipient (404), Claude Code will attempt to diagnose and fix \u2014 in one session it ran 'kg agent create web' after reading the 404 error message. This created a phantom 'web' agent in mux.db. Fixed by auto-registering senders in _handle_send.", "created_at": "2026-02-22T08:18:41.021399+00:00"}
{"id": "b-121036b8", "type": "gotcha", "text": "gotcha: mux auto-registers the from_agent (sender) when a message is received \u2014 uses to_agent's kg_root \u2014 so replies always route back without manual 'kg agent create'", "created_at": "2026-02-22T08:30:23.392812+00:00"}
{"id": "b-9a304579", "type": "fact", "text": "fact: messages.db has acked INTEGER DEFAULT 0 column; Stop hook calls _ack_messages_in_db() after writing ack files; web pending count uses WHERE acked=0", "created_at": "2026-02-22T08:30:27.088710+00:00"}
{"id": "b-dee11c81", "type": "gotcha", "text": "gotcha: Stop hook race \u2014 heartbeat updates urgent_delivered mid-session; Stop acks up to urgent_delivered so heartbeat-delivered-but-unprocessed msgs get silently lost; fix: new urgent_session_delivered field (only set by session-start / get_pending_messages); Stop acks up to urgent_session_delivered only", "created_at": "2026-02-22T08:30:31.516578+00:00"}
{"id": "b-482295f4", "type": "fact", "text": "fact: ack file has 5 fields: normal_delivered, normal_acked, urgent_delivered, urgent_session_delivered (set by session-start only), urgent_acked; heartbeat updates urgent_delivered but NOT urgent_session_delivered", "created_at": "2026-02-22T08:30:34.409433+00:00"}
{"id": "b-d73fe4e8", "type": "fact", "text": "fact: web UI sender 'web' is auto-registered in mux.db when it sends a message (using to_agent's kg_root); filtered out of web agents list via _has_toml flag; shows in kg agent list CLI", "created_at": "2026-02-22T08:30:38.508002+00:00"}
{"id": "b-a724886b", "type": "fact", "text": "fact: mux.db agents table has session_id TEXT column (migration via ALTER TABLE); _handle_session_start sets it from hook data; kg agent list shows session=<first 16 chars>", "created_at": "2026-02-22T08:30:53.415152+00:00"}
{"id": "b-bf9d9801", "type": "gotcha", "text": "Agents have no access to sent-message history \u2014 mux.db has only agents table; received messages live in .kg/messages/ JSONL but sent messages are not stored anywhere queryable. An agent cannot recall what it previously sent to another agent.", "created_at": "2026-02-22T08:30:54.161556+00:00"}
{"id": "b-d852019f", "type": "fact", "text": "fact: _list_agents in web.py only shows agents with _has_toml=True (set when TOML file found in .kg/agents/); auto-registered pseudo-agents like 'web' are hidden from web UI but visible in kg agent list CLI", "created_at": "2026-02-22T08:30:57.241732+00:00"}
{"id": "b-3c6fd412", "type": "gotcha", "text": "No inter-agent message history: mux.db only stores 'agents' table; messages are consumed on delivery with no retrievable log \u2014 agents cannot reconstruct what they previously sent to each other", "created_at": "2026-02-22T08:33:53.792547+00:00"}
{"id": "b-297d656c", "type": "gotcha", "text": "urgent_session_delivered ack field: session-start sets BOTH urgent_delivered AND urgent_session_delivered. Heartbeat only updates urgent_delivered. Stop hook acks only up to urgent_session_delivered \u2014 heartbeat-delivered-but-unprocessed urgents are NOT acked and re-delivered next session. Prevents race: message arrives during last turn, heartbeat delivers, Stop acks before agent processes.", "created_at": "2026-02-22T08:34:00.838101+00:00"}
{"id": "b-f13fbccc", "type": "fact", "text": "Auto-register sender in _handle_send: when mux receives a message, if from_name is not in mux.db (or has no kg_root), it is upserted with to_name's kg_root. Ensures agents can always reply to senders without a manual 'kg agent create' step. [[kg-architecture]]", "created_at": "2026-02-22T08:34:04.458730+00:00"}
{"id": "b-43f02af7", "type": "fact", "text": "get_pending_messages() MCP tool (mcp.py): calls POST /agent/{name}/session-start to fetch ALL undelivered messages (normal + urgent). Updates urgent_session_delivered so Stop acks them correctly. Default agent prompt calls this before stopping to catch messages that arrived during processing. [[kg-architecture]]", "created_at": "2026-02-22T08:34:12.100402+00:00"}
{"id": "b-b520263e", "type": "fact", "text": "session_id column in mux.db agents table (migration via ALTER TABLE ADD COLUMN). Populated by _handle_session_start from hook_data.session_id. 'kg agent list' shows session=<first 16 chars>. Launcher reads it to pass --resume on next launch. [[kg-agent-launcher]]", "created_at": "2026-02-22T08:34:16.024972+00:00"}
{"id": "b-6f95f429", "type": "gotcha", "text": "web pseudo-agent problem: test agent got 404 on reply to 'web' \u2192 error msg said 'run: kg agent create web' \u2192 agent ran it \u2192 'web' appeared as launchable agent in UI. Fixed by: (1) auto-register sender in _handle_send, (2) TOML filter in web agents list.", "created_at": "2026-02-22T08:34:26.673862+00:00"}
{"id": "b-a5523444", "type": "gotcha", "text": "(gotcha) get_pending_messages MCP tool does NOT consume messages on read \u2014 same messages reappear on every call within a session. Ack only advances at Stop hook (acked_through). This is intentional: crash recovery via two-pointer model (delivered_through reset on crash, re-reads from acked_through). Expect deduplication logic if calling multiple times in a session. [[kg-stop-hook]]", "created_at": "2026-02-22T08:36:02.313964+00:00"}
{"id": "b-7ad56449", "type": "gotcha", "text": "(gotcha) No sent-message history in mux.db \u2014 only an agents table. Messages are consumed on delivery (JSONL inbox read at SessionStart/heartbeat). Agents cannot query what messages they previously sent to other agents. mux.db is runtime state only (agent registry + heartbeat timestamps), not a communication log.", "created_at": "2026-02-22T08:36:06.582026+00:00"}
{"id": "b-70339bd4", "type": "gotcha", "text": "get_pending_messages MCP tool does NOT consume messages on read \u2014 same messages re-appear on every call until the Stop hook runs and advances the ack pointer. Agents must track what they've already replied to across calls within a session.", "created_at": "2026-02-22T08:36:33.992275+00:00"}
{"id": "b-fa82775f", "type": "fact", "text": "mux.db schema: only 'agents' table \u2014 no sent-message history. There is no way to look up messages an agent previously sent to another agent. Message logs are in JSONL inbox files for the recipient only.", "created_at": "2026-02-22T08:36:37.781139+00:00"}
{"id": "b-38a3871e", "type": "gotcha", "text": "urgent_session_delivered ack field: session-start sets BOTH urgent_delivered AND urgent_session_delivered. Stop hook acks only up to urgent_session_delivered \u2014 heartbeat-advanced urgent_delivered is NOT acked. Prevents Stop from acking heartbeat-injected messages the agent never processed (race: heartbeat fires just before agent exit). [[kg-stop-hook]]", "created_at": "2026-02-22T08:41:04.536470+00:00"}
{"id": "b-60c7c0b6", "type": "fact", "text": "Auto-register sender on message receipt: _handle_send() upserts from_name into mux DB with to_agent's kg_root when from_name is unknown. Enables replies without manual agent create. Prevents 404 when agent calls send_message back to 'web'. [[kg-architecture]]", "created_at": "2026-02-22T08:41:09.015509+00:00"}
{"id": "b-9461024d", "type": "fact", "text": "get_pending_messages() MCP tool: calls /agent/{name}/session-start to fetch ALL unacked messages (normal + urgent) regardless of heartbeat state. Agent should call this before stopping to catch messages that arrived after SessionStart. Also sets urgent_session_delivered so Stop will ack them. [[kg-stop-hook]]", "created_at": "2026-02-22T08:41:12.775006+00:00"}
{"id": "b-a6d5be75", "type": "fact", "text": "Web UI agent list filter: _list_agents() in web.py only shows agents with _has_toml=True (set when TOML found in .kg/agents/). Auto-registered pseudo-agents like 'web' (sender side-effect) are excluded from the list. Falls back to showing all if no TOML agents found. [[kg-web]]", "created_at": "2026-02-22T08:41:32.024548+00:00"}
{"id": "b-34e63960", "type": "fact", "text": "session_id stored in mux DB agents table (added this session): _handle_session_start() reads session_id from hook body and passes to _upsert_agent(). _upsert_agent() accepts session_id param, preserves existing if new is empty. Enables kg agent list to show session ID and launcher to --resume prior session.", "created_at": "2026-02-22T08:41:37.354236+00:00"}
{"id": "b-db4d8fb0", "type": "gotcha", "text": "Ack race condition fix: Stop hook only acks up to urgent_session_delivered (set by session-start + get_pending_messages), NOT urgent_delivered (advanced by heartbeat). Heartbeat-delivered urgents the agent did not process remain unacked and are re-delivered next session-start. Prevents messages being silently lost on timing race.", "created_at": "2026-02-22T08:50:44.469720+00:00"}
{"id": "b-d4fe7a53", "type": "fact", "text": "get_pending_messages() MCP tool (mcp.py): calls POST /agent/{name}/session-start to fetch all unacked messages (normal + urgent) with crash-recovery semantics. Also sets urgent_session_delivered so Stop hook will ack them. Agent should call before concluding to catch messages that arrived mid-session. [[kg-agent-launcher]]", "created_at": "2026-02-22T08:50:50.124432+00:00"}
{"id": "b-27c44659", "type": "fact", "text": "Auto-register sender: when mux handles POST /agent/{to_name}/messages and from_name is not in mux.db, mux auto-registers from_name with to_name's kg_root. Enables agent\u2192web replies without manual 'kg agent create web'. Done only if from_name has no existing kg_root entry.", "created_at": "2026-02-22T08:51:05.035618+00:00"}
{"id": "b-5b4bfddf", "type": "fact", "text": "Web UI agent list filtered to TOML-only agents: _list_agents() sets _has_toml=True on agents with a .kg/agents/<name>.toml file. Display filters to _has_toml agents only (fallback to all if none). Prevents auto-registered pseudo-agents like 'web' from cluttering the agents list.", "created_at": "2026-02-22T08:51:10.020193+00:00"}
{"id": "b-f03874fd", "type": "fact", "text": "session_id column added to mux.db agents table (migration via ALTER TABLE). Populated by _handle_session_start() from hook_data session_id. Used by launcher._get_prev_session_id() for --resume. Shown in 'kg agent list' output.", "created_at": "2026-02-22T08:51:14.187324+00:00"}
{"id": "b-e13c1d7e", "type": "fact", "text": "Default agent startup prompt (AgentDef._DEFAULT_PROMPT): (1) check session context for injected messages, (2) call get_pending_messages() for any late arrivals, (3) reply via send_message(to_agent=<sender>, body=<reply>), (4) call get_pending_messages() once more before stopping, (5) stop when inbox empty. Prevents missed messages from session-start/heartbeat race.", "created_at": "2026-02-22T08:51:19.211677+00:00"}
{"id": "b-8555ccbf", "type": "fact", "text": "urgent_session_delivered: new field in ack JSON. Set by session-start and get_pending_messages (both call the same session-start endpoint). NOT updated by heartbeat. Stop hook uses this field for urgent ack advancement, not urgent_delivered. ack file now has 5 fields: normal_delivered, normal_acked, urgent_delivered, urgent_session_delivered, urgent_acked.", "created_at": "2026-02-22T08:51:24.545624+00:00"}
{"id": "b-cfae451e", "type": "gotcha", "text": "(gotcha) Auto-registered pseudo-agents (like 'web' sender from web UI) get a mux.db entry but NO .kg/agents/<name>.toml \u2014 they are not launchable by the launcher. Only agents created via 'kg agent create <name>' get a TOML file and can be managed by the launcher. [[kg-agent-launcher]]", "created_at": "2026-02-22T09:06:12.806459+00:00"}
{"id": "b-2cb98f8f", "type": "decision", "text": "Agent coordination pattern: use a named 'coordinator' or 'test' agent (interactive, 'kg run test') as a relay between human-facing pseudo-agent ('web') and worker agents ('improve-web'). Coordinator receives messages from web UI and forwards to workers via send_message MCP tool. Worker sends results back to coordinator. [[kg-web]]", "created_at": "2026-02-22T09:06:18.326868+00:00"}
{"id": "b-e15d7fa2", "type": "fact", "text": "(gotcha) Stop hook must not ack messages past urgent_session_delivered \u2014 heartbeat sets urgent_delivered mid-session; acking at Stop would silently lose messages delivered but not yet processed [[kg-stop-hook]] [[kg-agent-launcher]]", "created_at": "2026-02-22T09:07:45.452636+00:00"}
{"id": "b-0ad9cea7", "type": "fact", "text": "(session) 577e2125-5a1 \u2014 fixed urgent_session_delivered ack boundary, added get_pending_messages() MCP tool, TOML-only web agent list, auto-register sender, session_id in mux DB [[kg-agent-launcher]] [[kg-stop-hook]]", "created_at": "2026-02-22T09:07:58.527765+00:00"}
{"id": "b-2ddf38b3", "type": "fact", "text": "agent creation: 'kg mux agent create <name>' = (1) upserts agent in mux.db; (2) writes .kg/agents/<name>.toml with auto_start=true, wake_on_message=true, restart=always; (3) creates KG nodes agent-<name>-instructions + agent-<name>. Top-level alias: 'kg agent create <name>'. [[kg-agent-launcher]]", "created_at": "2026-02-22T09:09:48.593233+00:00"}
{"id": "b-b9eb7e6a", "type": "fact", "text": "agent node naming convention: agent-<name>-mission (preferred) + agent-<name> (working memory). Older sessions used -instructions suffix \u2014 hooks.py falls back to it for legacy agents. New agents created with -mission suffix. [[agent-delegation]]", "created_at": "2026-02-22T09:25:02.896198+00:00"}
{"id": "b-01a34135", "type": "fact", "text": "instructions \u2192 mission rename (complete): agent-<name>-instructions nodes renamed to agent-<name>-mission. hooks.py _load_agent_instructions() tries -mission slug first then falls back to -instructions. cli.py 'kg agents init' creates -mission node. web.py _agent_link_for_node() recognizes -mission (primary), -instructions (legacy), -knowledge. node.jsonl slug/title fields updated to new slug.", "created_at": "2026-02-22T09:25:52.720849+00:00"}
{"id": "b-7af4f918", "type": "gotcha", "text": "urgent_session_delivered ack field (set only by session-start and get_pending_messages, NOT heartbeat): Stop hook acks urgent only up to urgent_session_delivered, preventing spurious acks of heartbeat-delivered messages the agent didn't process. Heartbeat-delivered-but-unacked messages re-deliver on next session-start.", "created_at": "2026-02-22T09:33:40.900120+00:00"}
{"id": "b-d51f3922", "type": "fact", "text": "Auto-register sender: when mux receives message from X to Y, auto-registers X in mux.db with Y's kg_root if X not yet registered. Enables agent\u2192sender replies without manual kg agent create.", "created_at": "2026-02-22T09:33:43.993443+00:00"}
{"id": "b-afb55a18", "type": "fact", "text": "TOML-only filter in web UI: _list_agents() only shows agents with .kg/agents/<name>.toml. Pseudo-agents (like 'web') auto-registered in mux.db are hidden from the list.", "created_at": "2026-02-22T09:33:47.699415+00:00"}
{"id": "b-67264ac3", "type": "fact", "text": "session_id TEXT column in mux.db agents table. Populated by _handle_session_start() from hook SessionStart event. Displayed in kg agent list.", "created_at": "2026-02-22T09:33:51.073836+00:00"}
{"id": "b-99625edd", "type": "fact", "text": "get_pending_messages() MCP tool: calls /agent/{name}/session-start to fetch all unacked messages (normal + urgent). Also advances urgent_session_delivered so Stop will ack them. Agent should call before stopping to catch messages that arrived mid-session.", "created_at": "2026-02-22T09:33:55.265800+00:00"}
{"id": "b-f6709449", "type": "fact", "text": "urgent_session_delivered: new ack field (alongside urgent_delivered). Set ONLY by session-start and get_pending_messages() calls \u2014 NOT by heartbeat. Stop hook acks urgent only up to urgent_session_delivered (not urgent_delivered). Prevents spurious ack of heartbeat-delivered messages that the agent didn't process before stopping.", "created_at": "2026-02-22T09:36:30.282327+00:00"}
{"id": "b-a1e05767", "type": "fact", "text": "get_pending_messages() MCP tool: calls session-start endpoint (not /pending) to fetch ALL unacked messages (normal+urgent) with crash recovery. Also advances urgent_session_delivered so Stop will ack them. Default agent prompt calls this before stopping to catch late-arriving messages. [[kg-architecture]]", "created_at": "2026-02-22T09:36:37.082309+00:00"}
{"id": "b-10ca5828", "type": "fact", "text": "Auto-register sender: _handle_send() auto-registers from_agent in mux.db with to_agent's kg_root if not already registered. Enables agent replies without manual 'kg agent create web'. Prevents the agent from needing to run kg agent create to route replies back.", "created_at": "2026-02-22T09:36:43.705749+00:00"}
{"id": "b-4291ee64", "type": "fact", "text": "TOML-only agent list: web UI _list_agents() only shows agents with a .kg/agents/<name>.toml file (_has_toml flag). Filters out auto-registered pseudo-agents like 'web' (the web UI sender). CLI kg agent list still shows all mux.db entries.", "created_at": "2026-02-22T09:36:50.658360+00:00"}
{"id": "b-3de5aae8", "type": "gotcha", "text": "Delivery race gotcha: if a message arrives after SessionStart but the agent is in its last processing turn, heartbeat may deliver it (updating urgent_delivered) but the agent generates its final response before seeing heartbeat injection. Stop then acks urgent_session_delivered (safe) but the heartbeat-delivered message is re-delivered next session. Agent's --resume context lets it detect the re-delivery.", "created_at": "2026-02-22T09:37:03.811537+00:00"}
{"id": "b-214736c6", "type": "fact", "text": "session_id column added to mux.db agents table (migration: ALTER TABLE agents ADD COLUMN session_id TEXT). Populated by _upsert_agent() at SessionStart. Shown in 'kg agent list' output. Used by launcher for --resume.", "created_at": "2026-02-22T09:37:09.669145+00:00"}
{"id": "b-287f4f76", "type": "fact", "text": "urgent_session_delivered ack field: only updated by session-start/get_pending_messages, NOT heartbeat. Stop hook acks urgent only up to urgent_session_delivered, preventing spurious acks of heartbeat-injected-but-unprocessed messages. Heartbeat-delivered messages re-delivered next session.", "created_at": "2026-02-22T09:42:29.570524+00:00"}
{"id": "b-a2c74d10", "type": "fact", "text": "get_pending_messages() MCP tool: calls /agent/{name}/session-start to fetch all unacked messages; also advances urgent_session_delivered so Stop hook acks correctly on exit. Agent should call before stopping to catch last-minute arrivals. [[kg-stop-hook]]", "created_at": "2026-02-22T09:42:32.604719+00:00"}
{"id": "b-706058fc", "type": "fact", "text": "auto-register sender on receive: _handle_send() upserts from_name into mux.db using recipient's kg_root when sender not already registered. Enables replies without manual 'kg agent create <sender>'.", "created_at": "2026-02-22T09:42:35.532100+00:00"}
{"id": "b-b6ce33e2", "type": "fact", "text": "bidirectional message display in web UI: _mux_agent_messages() queries WHERE to_agent=X OR from_agent=X \u2014 same message appears in both sender's and recipient's chat views. Not a broadcast bug; intentional for full conversation context. [[kg-web]]", "created_at": "2026-02-22T09:42:38.336499+00:00"}
{"id": "b-bf0f1ed0", "type": "fact", "text": "session_id column in mux.db agents table: stores current Claude Code session_id per agent. Launcher's _get_prev_session_id() reads it to pass --resume <id> for session continuity. Upserted at session-start via POST body.", "created_at": "2026-02-22T09:42:41.481479+00:00"}
{"id": "b-6c50af7b", "type": "gotcha", "text": "gotcha: acked-without-reply race \u2014 if agent receives urgent msg via get_pending_messages(), sets urgent_session_delivered, then is killed (SIGTERM) before replying, Stop hook acks the message. Next launch finds 0 pending and stops without processing. Message is permanently lost. Resend required.", "created_at": "2026-02-22T09:59:10.221712+00:00"}
{"id": "b-50ec65c3", "type": "fact", "text": "mux _handle_send kg_root fallback: if recipient has no kg_root in mux.db, falls back to sender's kg_root and auto-registers recipient. Prevents 404 when agent replies to 'web' pseudo-agent on fresh mux.db. Both auto-registers still occur: recipient gets sender's kg_root, sender gets recipient's kg_root (if unregistered).", "created_at": "2026-02-22T09:59:14.960791+00:00"}
{"id": "b-beb86fad", "type": "note", "text": "debug workflow: check .kg/messages/<agent>/acks/<sender>.json for ack state (normal_delivered/acked, urgent_delivered/session_delivered/acked). Cross-reference with messages.db WHERE acked=0. Discrepancy between ack files and messages.db acked column means stop hook didn't run (SIGTERM) or migration issue.", "created_at": "2026-02-22T09:59:39.376612+00:00"}
{"id": "b-208a3e75", "type": "gotcha", "text": "gotcha: urgent_session_delivered ack gap \u2014 if agent calls get_pending_messages() then is killed by SIGTERM before send_message(), Stop hook acks urgent_session_delivered even though no reply was sent. Next run finds 0 pending. Message is lost.", "created_at": "2026-02-22T10:04:02.469695+00:00"}
{"id": "b-9203cf35", "type": "fact", "text": "fix: implicit ack on reply (implemented) \u2014 _handle_send() checks if from_name has unacked urgents FROM to_name in its inbox; if so, acks urgent_session_delivered when the reply is sent. Stop hook no longer acks urgents \u2014 only normal messages. Re-delivery guaranteed if killed before replying.", "created_at": "2026-02-22T10:04:09.703901+00:00"}
{"id": "b-7a48e2dd", "type": "fact", "text": "fix: sender kg_root fallback in _handle_send \u2014 if recipient has no kg_root (e.g. 'web' not yet registered), fall back to sender's kg_root and auto-register recipient. Prevents 404 when agents reply to 'web' user on a fresh mux.", "created_at": "2026-02-22T10:04:13.740732+00:00"}
{"id": "b-2441b4f5", "type": "gotcha", "text": "gotcha+fix: pending-count endpoint used urgent_delivered (not urgent_acked) as after-ID for urgents \u2014 so messages injected into a session but not replied-to showed count=0 (launcher wouldn't wake agent). Fix: changed _handle_pending_count to use urgent_acked so unprocessed urgents are counted correctly. [[kg-agent-launcher]]", "created_at": "2026-02-22T10:04:28.698082+00:00", "updated_at": "2026-02-23T05:29:13.455962+00:00"}
{"id": "b-860b5118", "type": "gotcha", "text": "fix: _handle_pending_count must use urgent_acked (not urgent_delivered) \u2014 urgent_delivered advances on heartbeat/session-start injection; urgent_acked only advances on reply. Using urgent_delivered caused count=0 for messages that were injected but agent exited without replying \u2014 launcher never woke the agent. [[kg-agent-launcher]]", "created_at": "2026-02-23T05:29:18.138098+00:00"}
{"id": "b-cce2096f", "type": "note", "text": "debug recipe for idle-despite-pending: (1) check messages.db for acked=0 rows; (2) check ack file urgent_delivered vs urgent_acked; (3) curl /agent/<name>/pending-count; (4) if count=0 but acked=0 messages exist, check if kg_root is seeded in mux.db agents table", "created_at": "2026-02-23T05:29:27.505548+00:00"}
