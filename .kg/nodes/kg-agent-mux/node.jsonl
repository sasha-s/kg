{"v": 1, "slug": "kg-agent-mux", "title": "kg Agent Mux", "type": "concept", "created_at": "2026-02-22T04:30:50.924411+00:00"}
{"id": "b-a567c962", "type": "fact", "text": "kg mux commands: start, stop, status, send <to> <msg>, messages, agent create/list/delete. Web UI at /agents route on web_port (default 8347). [[kg-architecture]]", "created_at": "2026-02-22T04:30:54.857775+00:00", "updated_at": "2026-02-22T05:46:46.952309+00:00"}
{"id": "b-db154300", "type": "fact", "text": "kg.toml [agents] section: enabled (bool), name (optional fallback \u2014 prefer KG_AGENT_NAME env var), mux_url (default http://127.0.0.1:7346), mux_port (default 7346). Only enabled=true required; name resolved at runtime from env.", "created_at": "2026-02-22T04:30:58.777840+00:00", "updated_at": "2026-02-22T05:46:10.226650+00:00"}
{"id": "b-282102bd", "type": "fact", "text": "Agent mux quick start: (1) set enabled=true in [agents] of kg.toml, (2) kg mux start, (3) kg mux agent create alice, (4) KG_AGENT_NAME=alice claude, (5) kg mux send alice 'hello'. [[kg-architecture]]", "created_at": "2026-02-22T04:31:02.362202+00:00", "updated_at": "2026-02-22T05:46:15.445434+00:00"}
{"id": "b-bd0f2842", "type": "fact", "text": "Agent hooks: session-start (register + inject instructions + pending msgs), user-prompt-submit (poll new msgs), post-tool-use (heartbeat + urgent), stop (archive + ack or block), session-end (mark idle on crash). Hooks pass kg_root to mux at session-start and heartbeat. [[kg-stop-hook]]", "created_at": "2026-02-22T04:31:05.716242+00:00", "updated_at": "2026-02-22T06:08:05.673047+00:00"}
{"id": "b-26446901", "type": "gotcha", "text": "Mux is currently project-scoped: mux_db_path=.kg/index/mux.db and mux_pid_path=.kg/index/.mux.pid are relative to the kg project root. Two projects both running 'kg mux start' conflict on port 7346, and agents in different projects can't message each other.", "created_at": "2026-02-22T04:49:30.700895+00:00"}
{"id": "b-1e78fbd7", "type": "decision", "text": "Mux DB and PID are user-level: ~/.local/share/kg/mux.db and ~/.local/share/kg/.mux.pid (respects XDG_DATA_HOME). One mux serves all kg projects on the machine. start_background passes --db <path> --port <port> to subprocess.", "created_at": "2026-02-22T04:49:34.376273+00:00", "updated_at": "2026-02-22T05:46:23.753814+00:00"}
{"id": "b-348a9590", "type": "gotcha", "text": "Multiple agents on the same project all share the same name from kg.toml \u2014 they collide on the mux. Fix: KG_AGENT_NAME env var override (check os.environ before kg.toml). Allows e.g. KG_AGENT_NAME=worker-1 claude for each window.", "created_at": "2026-02-22T04:49:38.745547+00:00"}
{"id": "b-82a9dbb2", "type": "fact", "text": "Agent registration is automatic \u2014 no pre-registration step. First SessionStart hook auto-upserts the agent record into the mux agents table via POST /agent/{name}/session-start.", "created_at": "2026-02-22T04:49:41.790172+00:00"}
{"id": "b-5a934e6b", "type": "decision", "text": "Session archiving (transcript copy to .kg/sessions/<agent>/<session_id>.jsonl) is done by the Stop hook (_archive_session_local), not the mux server. Mux server is message routing only \u2014 no sessions_dir needed.", "created_at": "2026-02-22T04:49:47.291680+00:00", "updated_at": "2026-02-22T05:46:28.842981+00:00"}
{"id": "b-3a5eed87", "type": "fact", "text": "addressing scheme: local:alice = agent 'alice' on the local mux; sprite-name:alice = agent 'alice' on a remote mux (forwarded via sprite's HTTP proxy). Enables cross-sprite agent messaging.", "created_at": "2026-02-22T05:23:51.179787+00:00"}
{"id": "b-8cd8a2f7", "type": "decision", "text": "KG_AGENT_NAME env var overrides kg.toml name \u2014 allows multiple agents in same project to have distinct identities. Usage: KG_AGENT_NAME=worker-1 claude. Check os.environ before kg.toml at hook registration.", "created_at": "2026-02-22T05:23:55.974597+00:00", "updated_at": "2026-02-22T05:25:37.321549+00:00"}
{"id": "b-c8238510", "type": "decision", "text": "kg mux agent subcommands (implemented): 'create <name>' \u2014 upserts mux DB entry + creates agent-<name>-instructions + agent-<name> KG nodes; 'list' \u2014 shows agents with status + pending count; 'delete <name>' \u2014 removes from mux (KG nodes kept). [[agent-delegation]]", "created_at": "2026-02-22T05:29:45.630221+00:00", "updated_at": "2026-02-22T05:46:33.762666+00:00"}
{"id": "b-4a21b993", "type": "decision", "text": "'kg run <name>' command implemented \u2014 sets KG_AGENT_NAME env + reads .kg/agents/<name>.toml for model/working_dir; launches claude with optional --unsafe (--dangerously-skip-permissions). Usage: kg run alice, kg run alice --unsafe. [[sprites-dev]]", "created_at": "2026-02-22T05:29:47.887341+00:00", "updated_at": "2026-02-22T06:47:48.431797+00:00"}
{"id": "b-90968937", "type": "decision", "text": "Agent node pair: agent-<name>-instructions (verbatim injection at SessionStart, edit to change agent's mission) + agent-<name> (working memory, accumulated across sessions, accessed via MCP tools). Stop hook prompts extraction claude to write learnings to agent-<name>.", "created_at": "2026-02-22T05:40:25.057951+00:00", "updated_at": "2026-02-22T05:46:42.239811+00:00"}
{"id": "b-2a3b7a74", "type": "fact", "text": "'kg mux agent create <name>' should: (1) upsert agent in mux DB, (2) create agent-<name>-instructions node with starter bullet, (3) create agent-<name> node for working memory. [[agent-delegation]]", "created_at": "2026-02-22T05:40:28.729539+00:00"}
{"id": "b-b273c23e", "type": "decision", "text": "SessionStart hook injects: (1) agent-<name>-instructions bullets verbatim (mission/rules, like per-agent CLAUDE.md), (2) pending mux messages. agent-<name> working memory is NOT injected \u2014 accessed on demand via kg MCP tools.", "created_at": "2026-02-22T05:40:32.424292+00:00", "updated_at": "2026-02-22T05:46:37.996583+00:00"}
{"id": "b-26446901", "deleted": true}
{"id": "b-348a9590", "deleted": true}
{"id": "b-2a3b7a74", "deleted": true}
{"id": "b-f8f38ab1", "type": "gotcha", "text": "(gotcha) Current messages.status field + single acked_through on agents is broken for multi-sender: can't ack bob's messages independently from orchestrator's. Also single-inbox JSONL would have multiple writers \u2014 git conflict on sync.", "created_at": "2026-02-22T05:49:09.789849+00:00"}
{"id": "b-6aaa216a", "type": "decision", "text": "Per-sender inbox: ack state is per (agent, from_agent) pair \u2014 agent acks bob's messages independently from orchestrator's. File-based: .kg/messages/<agent>/acks/<sender>.json replaces acked_through column on agents table. SQLite acks table is cache only.", "created_at": "2026-02-22T05:49:11.542069+00:00", "updated_at": "2026-02-22T05:53:59.879221+00:00"}
{"id": "b-9ccb81a8", "type": "decision", "text": "JSONL inbox layout (implemented): .kg/messages/<agent>/inbox/from/<sender>/messages-00001.jsonl (normal, segment_lines=500) + urgent-00001.jsonl (urgent separate). Acks: .kg/messages/<agent>/acks/<sender>.json \u2192 {normal_delivered, normal_acked, urgent_delivered, urgent_acked}. One writer per path = zero git conflicts. SQLite messages.db = derived index, never committed.", "created_at": "2026-02-22T05:49:15.758304+00:00", "updated_at": "2026-02-22T06:07:37.146775+00:00"}
{"id": "b-72731acf", "type": "task", "text": "(task) planned: add send_message MCP tool \u2014 sender auto-populated from KG_AGENT_NAME env (inherited by MCP server subprocess), recipient is explicit arg. Closes agent communication loop without requiring Bash tool access.", "status": "pending", "created_at": "2026-02-22T05:49:17.131200+00:00"}
{"id": "b-c3435d7b", "type": "decision", "text": "Inbox cap (implemented): max 50 unacked normal messages per sender ([agents] max_inbox=50, 0=unlimited). Mux returns HTTP 429 if over cap and urgency != urgent. Urgent messages always accepted \u2014 bypass cap. Cap checked via messages.db COUNT query before writing JSONL.", "created_at": "2026-02-22T05:54:04.085727+00:00", "updated_at": "2026-02-22T06:07:42.307680+00:00"}
{"id": "b-bfc3aaef", "type": "fact", "text": "Sender identity: KG_AGENT_NAME is auto-used as sender by MCP send_message tool (MCP server subprocess inherits env from Claude Code session). Recipient is always explicit. Agents reply using from_agent field visible in injected message context.", "created_at": "2026-02-22T05:54:08.362307+00:00"}
{"id": "b-bcec911a", "type": "decision", "text": "Two-pointer ack model per sender: delivered_through (set when injected, reset on crash for re-delivery) + acked_through (set at Stop, permanent, safe for compaction). Crash = delivered_through > acked_through \u2192 re-read from acked_through on next SessionStart.", "created_at": "2026-02-22T05:57:55.616266+00:00"}
{"id": "b-7dcffb58", "type": "decision", "text": "mux agents table needs kg_root column \u2014 when agent registers at SessionStart it sends its project root. Mux uses kg_root to write message JSONL files to the correct project's .kg/messages/. Project-local messages.db (index) lives at .kg/index/messages.db.", "created_at": "2026-02-22T05:57:59.864699+00:00"}
{"id": "b-7e1691e6", "type": "decision", "text": "git_sync config fields added to AgentsConfig (git_repo, git_branch). Actual git operations (commit after ack, pull-rebase retry on conflict) not yet implemented. git_branch mandatory when git_sync=true \u2014 enforced at runtime. Separate repo recommended.", "created_at": "2026-02-22T05:58:05.125416+00:00", "updated_at": "2026-02-22T06:07:56.271181+00:00"}
{"id": "b-960de69a", "type": "task", "text": "planned: kg mux agent compact <name> \u2014 deletes fully-acked segment files (all message IDs <= acked_through). Safe because acked_through only advances at Stop. Identifies compactable segments by comparing last message ID in segment to acked_through.", "status": "pending", "created_at": "2026-02-22T05:58:09.035444+00:00"}
{"id": "b-f8f38ab1", "deleted": true}
{"id": "b-42eba444", "type": "fact", "text": "mux_messages CLI command queries .kg/index/messages.db (project-local), not mux.db. Supports --agent, --from, --urgency, --limit filters. mux.db only holds agents table now \u2014 no messages.", "created_at": "2026-02-22T06:08:11.580843+00:00"}
{"id": "b-d2da762e", "type": "gotcha", "text": "gotcha: agent_list CLI still queries messages table (which no longer exists in mux.db) for pending counts \u2014 will fail at runtime. Needs fix: query messages.db per-agent or remove pending count from list.", "created_at": "2026-02-22T06:08:16.221651+00:00"}
{"id": "b-3aabd697", "type": "decision", "text": "planned: Launcher \u2014 separate process from mux, manages agent runtimes on a node. Reads .kg/agents.toml (git-tracked declarative allocation). Responsible for: auto_start agents, wake_on_message (poll mux, start idle agents with pending msgs), restart policy (always/on-failure/never), PID tracking, graceful shutdown. [[agent-delegation]]", "created_at": "2026-02-22T06:12:27.490097+00:00"}
{"id": "b-c65fd6e6", "type": "decision", "text": "planned: .kg/agents.toml declares agent-to-node allocation (git-tracked). Fields per [[agent]]: name, node, auto_start, restart (always/on-failure/never), wake_on_message. Launcher reads this on its node and manages matching agents. Node identity from [agents] node= in kg.toml or KG_NODE_NAME env var.", "created_at": "2026-02-22T06:12:29.655496+00:00"}
{"id": "b-3bb91a2c", "type": "gotcha", "text": "gotcha: agent_list CLI (kg mux agent list) still queries messages table in mux.db for pending counts \u2014 table no longer exists after JSONL refactor. Fix: query .kg/index/messages.db per agent, or drop pending count from list output.", "created_at": "2026-02-22T06:12:34.046737+00:00"}
{"id": "b-3bb91a2c", "deleted": true}
{"id": "b-d1684a7e", "type": "decision", "text": "planned: Launcher \u2014 per-node process supervisor separate from mux. Reads .kg/agents/<name>.toml (one file per agent, git-tracked). Manages only agents with node==its own node name. Kills agents whose toml says node!=own node (reallocation). CLI: kg launcher start/stop/status + kg launcher agent start/stop/restart. [[agent-delegation]]", "created_at": "2026-02-22T06:17:02.924370+00:00"}
{"id": "b-03ee5a39", "type": "decision", "text": "planned: agent definition files at .kg/agents/<name>.toml \u2014 one per agent, git-tracked. Fields: name, node, auto_start, restart (always/on-failure/never), wake_on_message, model, working_dir. Created by 'kg mux agent create <name> --node <node>'. Launcher reads all .kg/agents/*.toml on its node.", "created_at": "2026-02-22T06:17:07.599214+00:00"}
{"id": "b-3101dbc6", "type": "decision", "text": "planned: pull-based node migration \u2014 change .kg/agents/alice.toml node= field + git commit + push. Launcher on old node sees node!=own \u2192 kills alice. Launcher on new node sees node==own \u2192 starts alice. No coordination between launchers needed.", "created_at": "2026-02-22T06:17:12.868274+00:00"}
{"id": "b-3aabd697", "deleted": true}
{"id": "b-c65fd6e6", "deleted": true}
{"id": "b-d1684a7e", "deleted": true}
{"id": "b-03ee5a39", "deleted": true}
{"id": "b-3101dbc6", "deleted": true}
{"id": "b-1a7718b1", "type": "gotcha", "text": "Bug: kg mux agent list used to query 'messages' table in mux.db for pending counts \u2014 that table no longer exists (messages moved to JSONL + project-local .kg/index/messages.db). Fix: query cfg.messages_db_path with 'SELECT to_agent, COUNT(*) FROM messages WHERE acked=0 GROUP BY to_agent', wrap in try/except.", "created_at": "2026-02-22T06:31:09.992165+00:00"}
{"id": "b-3f648b69", "type": "note", "text": "sessions_sync is local-only by default (.kg/sessions/<agent>/<session_id>.jsonl). A sessions_sync=true AgentsConfig option could trigger git add+commit in stop hook after _archive_session_local(), but not yet implemented \u2014 keeping sessions out of git avoids large binary blobs and transcript noise.", "created_at": "2026-02-22T06:31:14.977644+00:00"}
{"id": "b-d2da762e", "deleted": true}
{"id": "b-2e70f582", "type": "fact", "text": "sessions_sync=true in [agents]: stop hook git-adds .kg/sessions/<agent>/<session_id>.jsonl and creates a git commit ('session: <agent> <id>') after _archive_session_local. Opt-in, default false. Lets you track session history in git. [[kg-stop-hook]]", "created_at": "2026-02-22T06:40:51.501712+00:00"}
{"id": "b-72731acf", "deleted": true}
{"id": "b-3f648b69", "deleted": true}
{"id": "b-2dd90a3a", "type": "fact", "text": "Heartbeat timeout: [agents] heartbeat_timeout=10 (minutes, 0=disabled). Mux runs a background reaper thread (every 60s) that sets status='idle' WHERE status='running' AND last_seen < now-timeout. Wires through both start_server() and __main__ subprocess via --heartbeat-timeout arg.", "created_at": "2026-02-22T06:48:07.166965+00:00"}
{"id": "b-903e91ec", "type": "fact", "text": "send_message MCP tool (implemented in mcp.py): @mcp.tool() send_message(to_agent, body, urgency='normal') \u2192 str. Auto-uses cfg.agent_name (KG_AGENT_NAME env) as sender. POSTs to {mux_url}/agent/{to_agent}/messages. Returns message id or error string. Agents communicate without Bash access. [[kg-architecture]]", "created_at": "2026-02-22T06:48:13.071100+00:00"}
{"id": "b-8515f327", "type": "gotcha", "text": "(gotcha) kg init check bug: was 'cfg.agents.enabled and cfg.agents.name' \u2014 prevented mux auto-start when name came from KG_AGENT_NAME env at session time. Fixed to 'cfg.agents.enabled' only. Similarly kg mux send used cfg.agents.name (static) instead of cfg.agent_name (env-aware) \u2014 fixed.", "created_at": "2026-02-22T06:48:20.433978+00:00"}
{"id": "b-1e1e6cb6", "type": "fact", "text": "sessions_sync=true in [agents]: stop hook git-adds .kg/sessions/<agent>/<session_id>.jsonl and runs git commit ('session: <agent> <id[:16]>') after _archive_session_local. Opt-in (default false). heartbeat_timeout=10 (int, minutes). Both added to AgentsConfig dataclass + load_config() parsing. [[kg-stop-hook]]", "created_at": "2026-02-22T06:48:45.956146+00:00"}
